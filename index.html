<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ </title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f2f2f2;
      --panel:#ffffffee;
      --ink:#1f2a24;
      --muted:#65716a;
      --line:#e5e5e5;
      --accent:#1f7ae0;
      --good:#03C75A;
      --warn:#d9534f;
      --shadow:0 8px 24px rgba(0,0,0,.14);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box;}
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; background: var(--bg); user-select: none; color:var(--ink); }

    /* ===== Viewer ì˜ì—­ ===== */
    #viewer-area { position: absolute; inset: 0; z-index: 1; }
    #three-container { width: 100%; height: 100%; display: block; cursor: auto; }
    #twod-container {
      width: 100%; height: 100%; overflow: auto; display: none;
      background: #fff; position: relative;
      background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px);
      background-size: 40px 40px;
      touch-action: pan-x pan-y;
    }

    /* ===== íˆ´íŒ ===== */
    #tooltip {
      position: fixed; z-index: 9999; display: none; pointer-events: none;
      background: rgba(20, 20, 20, 0.95); color: #fff;
      padding: 10px 12px; border-radius: 10px;
      font-size: 13px; line-height: 1.5;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.10);
      min-width: 210px;
    }
    #tooltip b{display:block; color:#ffd700; margin-bottom:6px; font-size:14px;}
    #tooltip .row{display:flex; justify-content:space-between; gap:12px;}
    #tooltip .lbl{color:#bdbdbd;}
    #tooltip .val{font-weight:700;}

    /* ===== í† ìŠ¤íŠ¸ ===== */
    #toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(17, 17, 17, 0.92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 800;
      z-index: 99999;
      display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ===== UI íŒ¨ë„ ===== */
    #ui-shell{
      position:absolute; left: 12px; top: 12px; z-index: 100;
      width: 390px;
      max-height: calc(100vh - 24px);
      display:flex; flex-direction:column;
      gap:10px;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(4px);
    }

    .panel-header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      gap:10px;
    }

    .title{
      display:flex; flex-direction:column; gap:3px;
      min-width:0;
    }
    .title h3{
      margin:0;
      font-size:16px;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .badge{
      font-size:11px; padding:2px 7px; border-radius:999px;
      background:#222; color:#fff;
    }
    .subtitle{
      margin:0; font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .header-actions{display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .chip{
      border:1px solid #cfcfcf; background:#fff;
      border-radius:999px; padding:6px 10px;
      font-size:12px; cursor:pointer; font-weight:900;
      display:flex; align-items:center; gap:6px;
    }
    .chip:hover{background:#f7f7f7;}
    .chip.primary{border-color:#cfe1ff; background:#eef5ff;}
    .chip.warn{border-color:#ffd1d1; background:#fff1f1; color:#b51d1d;}

    .panel-body{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      max-height: calc(100vh - 120px);
    }

    .tabs{ display:flex; gap:6px; }
    .tab{
      flex:1;
      padding: 10px 10px;
      border-radius: 10px;
      border:1px solid #d7d7d7;
      background:#f2f2f2;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{ background:#222; color:#fff; border-color:#222; }

    .callout{
      background:#fff;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      font-size:12px;
      color:#2a2a2a;
      line-height:1.6;
    }
    .callout b{color:#000;}
    .callout .small{color:var(--muted); font-size:11px;}
    .callout .pill{
      display:inline-block;
      font-weight:1000;
      padding: 2px 8px;
      border-radius:999px;
      background:#eef5ff;
      border:1px solid #cfe1ff;
      color:#0b4ea5;
      margin-left:6px;
      font-size:11px;
    }
    .callout code{font-family:var(--mono); font-size:11px; background:#f5f5f5; padding:2px 6px; border-radius:8px;}

    textarea{
      width:100%;
      min-height: 110px;
      padding:10px;
      border:1px solid #cfcfcf;
      border-radius:12px;
      font-family:var(--mono);
      font-size:12px;
      resize:vertical;
      user-select:text;
      background:#fff;
    }

    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .btn{
      border:none; border-radius: 12px;
      padding: 11px 12px;
      font-weight:1000; cursor:pointer;
      font-size:13px;
      display:flex; align-items:center; justify-content:center; gap:8px;
      flex:1;
      min-width: 120px;
    }
    .btn.primary{background: var(--accent); color:#fff;}
    .btn.primary:hover{filter:brightness(.95);}
    .btn.ghost{background:#fff; border:1px solid #cfcfcf; color:#222;}
    .btn.ghost:hover{background:#f6f6f6;}
    .btn.good{background: var(--good); color:#fff;}
    .btn.good:hover{filter:brightness(.95);}
    .btn.warn{background:#ffeded; border:1px solid #ffc2c2; color:#b51d1d;}
    .btn.warn:hover{background:#ffe3e3;}

    .divider{height:1px; background:var(--line); margin:4px 0;}
    .mini{ font-size:11px; color:var(--muted); }

    /* ===== ë°© ì…ë ¥ í…Œì´ë¸” ===== */
    .table-wrap{
      background:#fff;
      border:1px solid var(--line);
      border-radius: 12px;
      overflow:hidden;
    }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{ padding:8px; border-bottom:1px solid #efefef; vertical-align:middle; }
    th{ background:#f6f6f6; font-weight:1000; color:#222; text-align:left; }
    td input{
      width:100%;
      padding:7px 8px;
      border:1px solid #d7d7d7;
      border-radius:10px;
      font-size:12px;
      font-family:var(--mono);
      user-select:text;
      background:#fff;
    }
    td input:focus{outline:2px solid rgba(31,122,224,0.20); border-color:#9cc3ff;}
    .td-actions{ display:flex; gap:6px; justify-content:flex-end; }
    .iconbtn{
      border:1px solid #d7d7d7;
      background:#fff;
      border-radius:10px;
      padding:7px 8px;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
    }
    .iconbtn:hover{background:#f5f5f5;}

    /* ===== 2D ë„í˜• ===== */
    .room-2d{
      position:absolute;
      border:2px solid #666;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      font-size:12px; color:#000;
      cursor:grab;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.10);
      touch-action:none;
      padding: 6px;
      text-align:center;
    }
    .room-2d.dragging{
      cursor:grabbing;
      opacity:0.85;
      z-index:999;
      box-shadow: 6px 6px 14px rgba(0,0,0,0.18);
    }
    .wall-section-title{
      position:absolute; font-weight:1000; font-size:16px;
      color:#222; padding:10px 10px 8px;
      border-bottom:2px solid #222;
      width:auto; left: 16px; right: 16px;
      background: rgba(255,255,255,0.85);
      border-radius: 12px;
    }

    /* ===== í•˜ë‹¨ íŒ¨ë°€ë¦¬ ë§í¬ ===== */
    .family{ display:flex; flex-direction:column; gap:8px; }
    .family a{ text-decoration:none; }
    .family .a-talk{
      background: var(--good);
      color:#fff;
      border-radius: 12px;
      padding: 12px;
      font-weight:1100;
      text-align:center;
    }
    .family .a-talk:hover{filter:brightness(.95);}
    .family .row2{ display:flex; gap:8px; }
    .family .a-site{
      background:#fff;
      border:1px solid #d7d7d7;
      border-radius: 12px;
      padding: 12px;
      font-weight:1000;
      text-align:center;
      color:#222;
      flex:1;
    }
    .family .a-site:hover{background:#f6f6f6;}
    .family .a-store{
      background:#1f2a24;
      color:#fff;
      border-radius: 12px;
      padding: 12px;
      font-weight:1100;
      text-align:center;
    }
    .family .a-store:hover{filter:brightness(.95);}

    /* ===== ëª¨ë°”ì¼: ë©”ë‰´ ì ‘ê¸°/í¼ì¹˜ê¸° ===== */
    #fab{
      position:absolute;
      right: 12px;
      bottom: 12px;
      z-index: 120;
      display:none;
      border:none;
      border-radius: 999px;
      padding: 12px 14px;
      background:#222;
      color:#fff;
      font-weight:1100;
      box-shadow: var(--shadow);
      cursor:pointer;
    }

    @media (max-width: 860px){
      #ui-shell{
        width: calc(100vw - 24px);
        left: 12px; top: auto; bottom: 12px;
        max-height: 62vh;
      }
      .panel-body{ max-height: calc(62vh - 58px); }
      #fab{display:block;}
      body.menu-collapsed #ui-shell{display:none;}
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>
  <div id="tooltip"></div>
  <div id="toast"></div>

  <button id="fab">â˜° ë©”ë‰´</button>

  <div id="ui-shell">
    <div class="panel">
      <div class="panel-header">
        <div class="title">
          <h3>ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ  <span class="badge">v2.21</span></h3>
          <p class="subtitle">â€œë°© ì¹˜ìˆ˜ë§Œ ë„£ìœ¼ë©´ ë²½ì²´ëŠ” ìë™ ê³„ì‚°â€</p>
        </div>
        <div class="header-actions">
          <button id="btnCopyJson" class="chip primary">ğŸ“‹ í†¡í†¡ìš© ë³µì‚¬</button>
          <button id="btnDownloadJson" class="chip">â¬‡ï¸ JSON íŒŒì¼</button>
          <button id="btnReset" class="chip warn">ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="panel-body">
        <div class="tabs">
          <button id="tab2D" class="tab">ğŸ“Š 2D</button>
          <button id="tab3D" class="tab active">ğŸ§Š 3D</button>
        </div>

        <div class="callout">
          <b>ë¬´ë£Œ 1ì°¨ ë¦¬í¬íŠ¸ ë°›ê¸°</b> <span class="pill">ì´ˆê°„ë‹¨</span><br/>
          1) ì•„ë˜ì— ë°© ë°ì´í„° ë„£ê¸° â†’ <b>ë„ë©´ ìƒì„±</b><br/>
          2) <b>ğŸ“‹ í†¡í†¡ìš© ë³µì‚¬</b> ë²„íŠ¼ ëˆ„ë¥´ê¸°<br/>
          3) ì•„ë˜ <b>í†¡í†¡ ìƒë‹´</b>ì— ë“¤ì–´ê°€ì„œ <b>ë¶™ì—¬ë„£ê¸°</b>í•˜ê³ , â€œ<b>1ì°¨ ë¦¬í¬íŠ¸ ìš”ì²­</b>â€ì´ë¼ê³  ë³´ë‚´ê¸°<br/>
          <span class="small">â€» ë³µì‚¬ë˜ëŠ” ë‚´ìš©(JSON)ì€ â€œì›¹íŒŒì¼â€ì´ ì•„ë‹ˆë¼ â€œë°ì´í„° í…ìŠ¤íŠ¸â€ì˜ˆìš”.</span>
        </div>

        <div class="callout">
          <b>ì‚¬ìš© ìˆœì„œ (ì§„ì§œ ì´ëŒ€ë¡œë§Œ)</b><br/>
          1) ì•„ë˜ì— <b>ë¶™ì—¬ë„£ê¸°</b> or <b>ì§ì ‘ ì…ë ¥</b><br/>
          2) <b>ë„ë©´ ìƒì„±</b> ë²„íŠ¼ í´ë¦­<br/>
          3) 3D: <code>Shift+ë“œë˜ê·¸</code>ë¡œ ë°© ì´ë™ / 2D: ë°©ì„ ëŒì–´ë‹¤ ë§ì¶”ê¸°<br/>
          <span class="small">â€» ìë™ì €ì¥: ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤(ì„œë²„ ì €ì¥ ì•„ë‹˜).</span>
        </div>

        <div class="callout">
          <b>â‘  ë¶™ì—¬ë„£ê¸°(ì¶”ì²œ)</b><br/>
          ì—‘ì…€/êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë°© ëª©ë¡ì„ ë“œë˜ê·¸ ë³µì‚¬í•´ì„œ ì—¬ê¸° ë¶™ì—¬ë„£ê¸° â†’ <b>ë„ë©´ ìƒì„±</b>.<br/>
          <span class="small">ì¸ì‹ ì¹¼ëŸ¼: ID / ë°©ì´ë¦„ / ê°€ë¡œ / ì„¸ë¡œ / (ì„ íƒ)ë†’ì´</span>
        </div>

        <textarea id="pasteBox" placeholder="ì˜ˆì‹œ(íƒ­ìœ¼ë¡œ êµ¬ë¶„)\n1\tê±°ì‹¤\t5.0\t4.0\t2.3\n2\tì¹¨ì‹¤1\t3.2\t3.0\t2.3\n3\tì£¼ë°©\t3.0\t2.6\t2.3"></textarea>

        <div class="row">
          <button id="btnLoadFromPaste" class="btn ghost">ğŸ“¥ ë¶™ì—¬ë„£ê¸° ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="btnSample" class="btn ghost">ğŸ§ª ìƒ˜í”Œ ë„£ê¸°</button>
          <button id="btnBuild" class="btn primary">ğŸ—ï¸ ë„ë©´ ìƒì„±</button>
        </div>

        <div class="divider"></div>

        <div class="callout">
          <b>â‘¡ ì§ì ‘ ì…ë ¥(ë¶™ì—¬ë„£ê¸° ì‹«ì€ ë¶„)</b><br/>
          ì•„ë˜ í‘œì— ì ê³  <b>ë„ë©´ ìƒì„±</b> ëˆ„ë¥´ë©´ ë.<br/>
          <span class="small">ê°€ë¡œ/ì„¸ë¡œëŠ” më¡œ ì…ë ¥. 5000 ê°™ì€ ê°’ì€ mmë¡œ ë³´ê³  ìë™ ë³€í™˜.</span>
        </div>

        <div class="row">
          <button id="btnAddRoom" class="btn good">â• ë°© ì¶”ê°€</button>
          <button id="btnToggleWindows" class="btn ghost">ğŸªŸ ì°½ë¬¸ ì…ë ¥(ì„ íƒ)</button>
          <button id="btnCapture" class="btn ghost">ğŸ“¸ ìº¡ì²˜(P)</button>
        </div>

        <div class="table-wrap">
          <table id="roomTable">
            <thead id="roomThead"></thead>
            <tbody id="roomTbody"></tbody>
          </table>
        </div>

        <div class="mini" id="statusLine">ì €ì¥ ìƒíƒœ: -</div>

        <div class="divider"></div>

        <div class="family">
          <a class="a-talk" href="https://talk.naver.com/W4HB1I" target="_blank">ğŸ’¬ ëš±ëšœë£¨ ê±´ì¶•ì‚¬ì™€ í†¡í†¡ ìƒë‹´í•˜ê¸°</a>
          <div class="row2">
            <a class="a-site" href="https://yugy.org" target="_blank">ğŸ  ê³µì‹í™ˆ</a>
            <a class="a-site" href="https://yugy.cloud" target="_blank">â˜ï¸ ëª¨ë¸í•˜ìš°ìŠ¤</a>
          </div>
          <a class="a-store" href="https://yugy.store" target="_blank">ğŸŒ¿ ê·¸ë¦°ë¦¬ëª¨ë¸ë§ ì§„ë‹¨/ì»¨ì„¤íŒ… (yugy.store)</a>
        </div>
      </div>
    </div>
  </div>

  <div id="viewer-area">
    <div id="twod-container"></div>
    <div id="three-container"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // =========================
    // 0) ê¸°ë³¸ ìƒìˆ˜/ìƒíƒœ
    // =========================
    const VERSION = "2.21";
    const STORAGE_KEY = "yugy_site_rooms_v221";
    const TALK_URL = "https://talk.naver.com/W4HB1I";

    const EXCEL_COLORS = [
      "#FFCCCC","#FFE5CC","#FFFFCC","#E5FFCC","#CCFFCC","#CCFFE5","#CCFFFF","#CCE5FF","#CCCCFF","#E5CCFF",
      "#FFCCFF","#FFE5FF","#FFB2B2","#FFD6A5","#FFEF9F","#CAE799","#A6E3A1","#99DDCC","#9FDBFF","#ADC1FF",
      "#C8B2FF","#E0B2FF","#FFB2F5","#FFB2D7","#FFB2B2","#FF8282","#FFAA64","#FFD246","#B4DC5A","#78D296"
    ];

    let state = {
      mode: "3d",
      windowsEnabled: false,
      rooms: []
    };

    const el = (id)=>document.getElementById(id);
    const statusLine = el("statusLine");
    const toast = el("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{ toast.style.display="none"; }, 2600);
    }

    function nowStamp(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // mm/m ìë™ íŒë³„: 100ë³´ë‹¤ í¬ë©´ mmë¡œ ë³´ê³  më¡œ ë³€í™˜
    function smartUnitToM(val){
      if(val === null || val === undefined || val === "") return 0;
      let num = val;
      if(typeof val !== "number"){
        const s = String(val).trim().replace(/[^0-9.\-]/g,'');
        num = Number(s);
      }
      if(!isFinite(num)) return 0;
      if(num > 100) return num/1000; // mm -> m
      return num; // m
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function autoId(){
      const maxId = state.rooms.reduce((m,r)=>Math.max(m, r.id||0), 0);
      return maxId + 1;
    }

    function normalizeRoom(r){
      const id = Number(r.id)||0;
      const name = String(r.name||"").trim();
      const w = smartUnitToM(r.w);
      const d = smartUnitToM(r.d);
      let h = smartUnitToM(r.h);
      if(!h || h <= 0) h = 2.3;
      return {
        id: id>0?id:autoId(),
        name: name || `ê³µê°„${id||autoId()}`,
        w: Number(w.toFixed(3)),
        d: Number(d.toFixed(3)),
        h: Number(h.toFixed(3)),
        x2d: r.x2d ?? null,
        y2d: r.y2d ?? null,
        win: r.win || {A:{w:0,h:0},B:{w:0,h:0},C:{w:0,h:0},D:{w:0,h:0}}
      };
    }

    function setStatus(msg){
      statusLine.textContent = `ì €ì¥ ìƒíƒœ: ${msg}`;
    }

    function save(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({version:VERSION, state}));
        setStatus(`ìë™ì €ì¥ë¨ âœ… (${nowStamp()})`);
      }catch(e){
        setStatus("ì €ì¥ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ì œí•œ) âŒ");
      }
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(parsed?.state){
          state = parsed.state;
        }
      }catch(e){}
    }

    // =========================
    // 1) í‘œ ë Œë”ë§
    // =========================
    const thead = el("roomThead");
    const tbody = el("roomTbody");

    function tableHeaders(){
      const base = `
        <tr>
          <th style="width:52px;">ID</th>
          <th>ë°©ì´ë¦„</th>
          <th style="width:86px;">ê°€ë¡œ(m)</th>
          <th style="width:86px;">ì„¸ë¡œ(m)</th>
          <th style="width:86px;">ë†’ì´(m)</th>
          ${state.windowsEnabled ? `
            <th style="width:70px;">AğŸªŸW</th><th style="width:70px;">AğŸªŸH</th>
            <th style="width:70px;">BğŸªŸW</th><th style="width:70px;">BğŸªŸH</th>
            <th style="width:70px;">CğŸªŸW</th><th style="width:70px;">CğŸªŸH</th>
            <th style="width:70px;">DğŸªŸW</th><th style="width:70px;">DğŸªŸH</th>
          ` : ``}
          <th style="width:120px; text-align:right;">ì‘ì—…</th>
        </tr>
      `;
      thead.innerHTML = base;
    }

    function inputCell(value, placeholder=""){
      return `<input value="${value ?? ""}" placeholder="${placeholder}">`;
    }

    function renderTable(){
      tableHeaders();
      tbody.innerHTML = "";

      state.rooms.forEach((r, idx)=>{
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${inputCell(r.id, "")}</td>
          <td>${inputCell(r.name, "ì˜ˆ: ê±°ì‹¤")}</td>
          <td>${inputCell(r.w, "ì˜ˆ: 5")}</td>
          <td>${inputCell(r.d, "ì˜ˆ: 4")}</td>
          <td>${inputCell(r.h, "ì˜ˆ: 2.3")}</td>
          ${state.windowsEnabled ? `
            <td>${inputCell(r.win?.A?.w ?? 0, "0")}</td>
            <td>${inputCell(r.win?.A?.h ?? 0, "0")}</td>
            <td>${inputCell(r.win?.B?.w ?? 0, "0")}</td>
            <td>${inputCell(r.win?.B?.h ?? 0, "0")}</td>
            <td>${inputCell(r.win?.C?.w ?? 0, "0")}</td>
            <td>${inputCell(r.win?.C?.h ?? 0, "0")}</td>
            <td>${inputCell(r.win?.D?.w ?? 0, "0")}</td>
            <td>${inputCell(r.win?.D?.h ?? 0, "0")}</td>
          ` : ``}
          <td class="td-actions">
            <button class="iconbtn" data-act="dup" data-idx="${idx}">ë³µì œ</button>
            <button class="iconbtn" data-act="del" data-idx="${idx}">ì‚­ì œ</button>
          </td>
        `;

        const inputs = tr.querySelectorAll("input");
        let p = 0;

        inputs[p++].addEventListener("input", e=>{ state.rooms[idx].id = Number(e.target.value)||autoId(); save(); });
        inputs[p++].addEventListener("input", e=>{ state.rooms[idx].name = e.target.value; save(); });
        inputs[p++].addEventListener("input", e=>{ state.rooms[idx].w = smartUnitToM(e.target.value); save(); });
        inputs[p++].addEventListener("input", e=>{ state.rooms[idx].d = smartUnitToM(e.target.value); save(); });
        inputs[p++].addEventListener("input", e=>{ state.rooms[idx].h = smartUnitToM(e.target.value)||2.3; save(); });

        if(state.windowsEnabled){
          const walls = ["A","B","C","D"];
          for(const wkey of walls){
            const iw = inputs[p++], ih = inputs[p++];
            iw.addEventListener("input", e=>{
              state.rooms[idx].win ||= {A:{w:0,h:0},B:{w:0,h:0},C:{w:0,h:0},D:{w:0,h:0}};
              state.rooms[idx].win[wkey].w = smartUnitToM(e.target.value);
              save();
            });
            ih.addEventListener("input", e=>{
              state.rooms[idx].win ||= {A:{w:0,h:0},B:{w:0,h:0},C:{w:0,h:0},D:{w:0,h:0}};
              state.rooms[idx].win[wkey].h = smartUnitToM(e.target.value);
              save();
            });
          }
        }

        tr.querySelectorAll(".iconbtn").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.dataset.act;
            const i = Number(btn.dataset.idx);
            if(act==="del"){
              state.rooms.splice(i,1);
            }else if(act==="dup"){
              const base = state.rooms[i];
              const copy = normalizeRoom({
                ...base,
                id: autoId(),
                name: base.name + "_ë³µì œ"
              });
              state.rooms.splice(i+1, 0, copy);
            }
            save();
            renderTable();
          });
        });

        tbody.appendChild(tr);
      });

      if(state.rooms.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="${state.windowsEnabled? (5+8+1) : (5+1)}" style="padding:14px; color:#666;">
          ì•„ì§ ë°©ì´ ì—†ì–´ìš”. <b>â• ë°© ì¶”ê°€</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </td>`;
        tbody.appendChild(tr);
      }
    }

    // =========================
    // 2) ë¶™ì—¬ë„£ê¸° íŒŒì„œ
    // =========================
    function splitCols(line){
      const t = (line||"").trim();
      if(!t) return null;
      if(/ê³µê°„id|ê³µê°„ëª…|ë°©ì´ë¦„|ê°€ë¡œ|ì„¸ë¡œ|ë©´ì |ë‘˜ë ˆ|ë²½ë†’ì´/i.test(t)) return null;
      if(t.includes("\t")) return t.split("\t").map(s=>s.trim());
      if(t.includes(",")) return t.split(",").map(s=>s.trim());
      return t.split(/\s+/).map(s=>s.trim());
    }

    function loadFromPaste(text){
      const lines = String(text||"").split(/\r?\n/);
      const rooms = [];

      for(const line of lines){
        const cols = splitCols(line);
        if(!cols || cols.length < 4) continue;
        const id = Number(cols[0]) || 0;
        const name = cols[1];
        const w = smartUnitToM(cols[2]);
        const d = smartUnitToM(cols[3]);

        let h = 0;
        if(cols.length >= 5) h = smartUnitToM(cols[4]);
        if((!h || h<=0) && cols.length >= 8) h = smartUnitToM(cols[7]);
        if(!h || h<=0) h = 2.3;

        if(String(name||"").trim() && w>0 && d>0){
          rooms.push(normalizeRoom({id, name, w, d, h}));
        }
      }
      return rooms;
    }

    // =========================
    // 3) 2D ëª¨ë“œ
    // =========================
    const twodContainer = el("twod-container");
    const SCALE_2D = 60;

    let active2DItem = null;
    let active2DOffset = {x:0,y:0};

    function save2DPositions(){
      const rooms = twodContainer.querySelectorAll(".room-2d.draggable");
      rooms.forEach(r=>{
        const id = Number(r.dataset.id);
        const match = state.rooms.find(x=>x.id===id);
        if(match){
          match.x2d = r.style.left;
          match.y2d = r.style.top;
        }
      });
      save();
    }

    twodContainer.addEventListener("pointerdown", e=>{
      const target = e.target.closest(".room-2d.draggable");
      if(!target) return;
      active2DItem = target;
      active2DItem.classList.add("dragging");
      const rect = active2DItem.getBoundingClientRect();
      active2DOffset.x = e.clientX - rect.left;
      active2DOffset.y = e.clientY - rect.top;
    });

    twodContainer.addEventListener("pointermove", e=>{
      if(!active2DItem) return;
      e.preventDefault();
      const containerRect = twodContainer.getBoundingClientRect();
      const currentX = e.clientX - containerRect.left + twodContainer.scrollLeft;
      const currentY = e.clientY - containerRect.top + twodContainer.scrollTop;
      active2DItem.style.left = (currentX - active2DOffset.x) + "px";
      active2DItem.style.top  = (currentY - active2DOffset.y) + "px";
    });

    function release2D(){
      if(active2DItem){
        active2DItem.classList.remove("dragging");
        active2DItem = null;
        save2DPositions();
      }
    }
    twodContainer.addEventListener("pointerup", release2D);
    twodContainer.addEventListener("pointerleave", release2D);

    function build2DScene(){
      twodContainer.innerHTML = "";
      if(!state.rooms.length) return;

      const title1 = document.createElement("div");
      title1.className = "wall-section-title";
      title1.textContent = "1) ë°”ë‹¥ í‰ë©´ (ë°©ì„ ëŒì–´ë‹¤ ë§ì¶”ì„¸ìš”)";
      title1.style.top = "10px";
      twodContainer.appendChild(title1);

      const START_X = 18, START_Y = 64, LIMIT = 1400, GAP = 18;
      let currentX = START_X, currentY = START_Y, maxRowH = 0;
      let maxYPoint = 0;

      state.rooms.forEach((r)=>{
        const color = EXCEL_COLORS[(r.id-1) % EXCEL_COLORS.length] || "#ddd";
        const wPx = r.w * SCALE_2D;
        const dPx = r.d * SCALE_2D;

        let posX, posY;
        if(r.x2d && r.y2d){
          posX = r.x2d; posY = r.y2d;
        }else{
          if(currentX + wPx > START_X + LIMIT){
            currentX = START_X;
            currentY += maxRowH + GAP;
            maxRowH = 0;
          }
          posX = currentX + "px";
          posY = currentY + "px";
          currentX += wPx + GAP;
          maxRowH = Math.max(maxRowH, dPx);
        }

        const div = document.createElement("div");
        div.className = "room-2d draggable";
        div.dataset.id = r.id;
        div.style.left = posX;
        div.style.top  = posY;
        div.style.width  = wPx + "px";
        div.style.height = dPx + "px";
        div.style.background = color;

        const area = (r.w * r.d).toFixed(2);
        div.innerHTML = `<b style="font-size:13px;">${r.name}</b>
          <div style="font-size:11px; color:#222; margin-top:4px;">${r.w} Ã— ${r.d} m</div>
          <div style="font-size:11px; color:#444;">ë©´ì  ${area} ã¡</div>`;
        twodContainer.appendChild(div);

        const bottomEdge = parseFloat(posY) + dPx;
        if(bottomEdge > maxYPoint) maxYPoint = bottomEdge;
      });

      let wallStartY = Math.max(maxYPoint + 120, 520);
      const title2 = document.createElement("div");
      title2.className = "wall-section-title";
      title2.textContent = "2) ë²½ì²´ ì „ê°œ(ìë™ ê³„ì‚°, ì°¸ê³ ìš©)";
      title2.style.top = wallStartY + "px";
      twodContainer.appendChild(title2);
      wallStartY += 60;

      state.rooms.forEach((r)=>{
        const color = EXCEL_COLORS[(r.id-1) % EXCEL_COLORS.length] || "#ddd";
        const hPx = r.h * SCALE_2D;

        const perim = (r.w + r.d) * 2;
        const wallArea = perim * r.h;
        const floorArea = r.w * r.d;

        const winArea = state.windowsEnabled ? (["A","B","C","D"].reduce((sum,k)=>{
          const ww = r.win?.[k]?.w||0;
          const wh = r.win?.[k]?.h||0;
          return sum + (ww>0&&wh>0 ? ww*wh : 0);
        },0)) : 0;
        const netWall = Math.max(0, wallArea - winArea);

        const label = document.createElement("div");
        label.style.position = "absolute";
        label.style.left = "16px";
        label.style.top  = (wallStartY + hPx/2 - 30) + "px";
        label.style.lineHeight = "1.35";
        label.innerHTML = `
          <b style="font-size:14px;">[${r.name}]</b> <span style="font-size:11px; color:#666;">(H:${r.h}m)</span><br/>
          <span style="font-size:12px; color:#333;">
            ë°”ë‹¥ ${floorArea.toFixed(2)}ã¡<br/>
            ë‘˜ë ˆ <b>${perim.toFixed(2)}m</b><br/>
            ë²½ë©´ì  <b>${wallArea.toFixed(2)}ã¡</b>
            ${state.windowsEnabled ? `<br/>ì°½ë©´ì  -<b>${winArea.toFixed(2)}ã¡</b> / ì‹¤ë²½ <b>${netWall.toFixed(2)}ã¡</b>` : ``}
          </span>`;
        twodContainer.appendChild(label);

        let x = 150;
        const walls = [
          {k:"A", n:"ë²½-A(ì•)", l:r.w},
          {k:"B", n:"ë²½-B(ìš°)", l:r.d},
          {k:"C", n:"ë²½-C(ë’¤)", l:r.w},
          {k:"D", n:"ë²½-D(ì¢Œ)", l:r.d}
        ];

        walls.forEach((w)=>{
          const wLenPx = w.l * SCALE_2D;
          const wall = document.createElement("div");
          wall.className = "room-2d";
          wall.style.left = x + "px";
          wall.style.top  = wallStartY + "px";
          wall.style.width  = wLenPx + "px";
          wall.style.height = hPx + "px";
          wall.style.background = color;
          wall.style.cursor = "default";

          const win = r.win?.[w.k] || {w:0,h:0};
          const winText = (state.windowsEnabled && win.w>0 && win.h>0) ? `<div style="font-size:11px; color:#004b78;">ğŸªŸ ${win.w}Ã—${win.h}m</div>` : "";

          wall.innerHTML = `<div style="font-weight:1000;">${w.n}</div>
            <div style="font-size:11px;">${w.l}Ã—${r.h}m</div>${winText}`;

          twodContainer.appendChild(wall);
          x += wLenPx + 10;
        });

        wallStartY += hPx + 60;
      });

      const spacer = document.createElement("div");
      spacer.style.position="absolute";
      spacer.style.top = wallStartY + "px";
      spacer.style.height = "200px";
      spacer.style.width="10px";
      twodContainer.appendChild(spacer);
    }

    // =========================
    // 4) 3D ëª¨ë“œ
    // =========================
    const tooltip = el("tooltip");
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf2f2f2);

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 2000);
    camera.position.set(12, 12, 16);
    camera.lookAt(0,0,0);

    const renderer = new THREE.WebGLRenderer({antialias:true, preserveDrawingBuffer:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    el("three-container").appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.75));
    const dir = new THREE.DirectionalLight(0xffffff, 0.85);
    dir.position.set(50, 80, 40);
    dir.castShadow = true;
    scene.add(dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    scene.add(new THREE.GridHelper(120, 120, 0xbdbdbd, 0xeeeeee));

    const raycaster = new THREE.Raycaster();
    const dragPlane = new THREE.Plane(new THREE.Vector3(0,1,0), 0);
    const dragOffset = new THREE.Vector3();
    let shiftDown = false;
    let dragging = false;
    let draggedGroup = null;

    let pieces = [];
    let hitMeshes = [];

    function clear3D(){
      pieces.forEach(p=>scene.remove(p));
      pieces = [];
      hitMeshes = [];
    }

    function createWindowPlane(width, height){
      const geo = new THREE.PlaneGeometry(width, height);
      const mat = new THREE.MeshStandardMaterial({
        color: 0x87d7ff,
        transparent: true,
        opacity: 0.55,
        side: THREE.DoubleSide,
        roughness: 0.3
      });
      return new THREE.Mesh(geo, mat);
    }

    function create3DRoom(r, colorHex){
      const group = new THREE.Group();
      const w = r.w, d = r.d, h = r.h;

      const matColor = new THREE.Color(colorHex);
      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(w, d),
        new THREE.MeshStandardMaterial({color: matColor, side:THREE.DoubleSide})
      );
      floor.rotation.x = -Math.PI/2;
      floor.position.y = 0.01;
      floor.receiveShadow = true;
      group.add(floor);

      const wallMat = new THREE.MeshStandardMaterial({
        color: matColor,
        roughness: 0.7,
        transparent:true,
        opacity: 0.88
      });

      const wallT = 0.10;

      const front = new THREE.Mesh(new THREE.BoxGeometry(w, h, wallT), wallMat);
      front.position.set(0, h/2, -d/2);
      group.add(front);

      const back = front.clone();
      back.position.set(0, h/2,  d/2);
      group.add(back);

      const left = new THREE.Mesh(new THREE.BoxGeometry(d, h, wallT), wallMat);
      left.rotation.y = Math.PI/2;
      left.position.set(-w/2, h/2, 0);
      group.add(left);

      const right = left.clone();
      right.position.set( w/2, h/2, 0);
      group.add(right);

      // ì°½ë¬¸ í‘œì‹œ(ì„ íƒ)
      if(state.windowsEnabled && r.win){
        const addWin = (wallKey, win, wallW, wallH, pos, rotY)=>{
          if(!win || win.w<=0 || win.h<=0) return;
          const ww = clamp(win.w, 0.1, Math.max(0.12, wallW-0.08));
          const wh = clamp(win.h, 0.1, Math.max(0.12, wallH-0.08));
          const plane = createWindowPlane(ww, wh);
          plane.position.copy(pos);
          plane.position.y = Math.min(h - wh/2 - 0.05, Math.max(wh/2 + 0.05, h/2));
          plane.rotation.y = rotY;
          group.add(plane);
        };

        const A = r.win.A || {w:0,h:0};
        const B = r.win.B || {w:0,h:0};
        const C = r.win.C || {w:0,h:0};
        const D = r.win.D || {w:0,h:0};

        addWin("A", A, w, h, new THREE.Vector3(0, h/2, -d/2 + 0.06), 0);
        addWin("C", C, w, h, new THREE.Vector3(0, h/2,  d/2 - 0.06), 0);
        addWin("D", D, d, h, new THREE.Vector3(-w/2 + 0.06, h/2, 0), Math.PI/2);
        addWin("B", B, d, h, new THREE.Vector3( w/2 - 0.06, h/2, 0), Math.PI/2);
      }

      // ë¼ë²¨
      const labelCanvas = document.createElement("canvas");
      const ctx = labelCanvas.getContext("2d");
      ctx.font = "bold 40px Malgun Gothic";
      const textW = ctx.measureText(r.name).width + 60;
      labelCanvas.width = Math.max(260, Math.ceil(textW));
      labelCanvas.height = 120;
      ctx.fillStyle="rgba(255,255,255,0.88)";
      ctx.fillRect(0,0,labelCanvas.width,labelCanvas.height);
      ctx.strokeStyle="#333";
      ctx.lineWidth=5;
      ctx.strokeRect(0,0,labelCanvas.width,labelCanvas.height);
      ctx.fillStyle="#000";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.fillText(r.name, labelCanvas.width/2, 42);
      ctx.font="26px Malgun Gothic";
      ctx.fillText(`(${r.w}Ã—${r.d}Ã—${r.h}m)`, labelCanvas.width/2, 86);

      const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(labelCanvas)}));
      sprite.scale.set(labelCanvas.width/85, 2.2, 1);
      sprite.position.set(0, h + 1.7, 0);
      group.add(sprite);

      // íˆíŠ¸ ë©”ì‹œ
      const hit = new THREE.Mesh(
        new THREE.PlaneGeometry(w, d),
        new THREE.MeshBasicMaterial({visible:false})
      );
      hit.rotation.x = -Math.PI/2;
      hit.position.y = 0.12;
      hit.userData.parentGroup = group;
      group.add(hit);
      hitMeshes.push(hit);

      // ë©”íŠ¸ë¦­
      const floorArea = w*d;
      const perim = (w+d)*2;
      const wallArea = perim*h;
      const winArea = state.windowsEnabled ? (["A","B","C","D"].reduce((sum,k)=>{
        const ww = r.win?.[k]?.w||0;
        const wh = r.win?.[k]?.h||0;
        return sum + (ww>0&&wh>0 ? ww*wh : 0);
      },0)) : 0;

      group.userData = {
        id:r.id,
        name:r.name,
        w,d,h,
        metrics:{
          floor: floorArea,
          ceil: floorArea,
          perim,
          wall: wallArea,
          win: winArea,
          netWall: Math.max(0, wallArea - winArea)
        }
      };

      return group;
    }

    function build3DScene(){
      clear3D();
      if(!state.rooms.length) return;

      let x = 0, z = 0, rowH = 0;
      const LIMIT = 24;

      state.rooms.forEach((r)=>{
        const color = EXCEL_COLORS[(r.id-1) % EXCEL_COLORS.length] || "#ccc";
        const group = create3DRoom(r, color);

        if(x + r.w > LIMIT){
          x = 0;
          z += rowH + 0.6;
          rowH = 0;
        }

        const target = new THREE.Vector3(x + r.w/2, 0, z + r.d/2);

        group.position.set(
          target.x + (Math.random()-0.5)*10,
          0,
          target.z + 6 + Math.random()*6
        );

        group.userData.targetPos = target;

        x += r.w + 0.6;
        rowH = Math.max(rowH, r.d);

        scene.add(group);
        pieces.push(group);
      });
    }

    function getMouse(e){
      const rect = renderer.domElement.getBoundingClientRect();
      return {
        x: ((e.clientX - rect.left)/rect.width)*2 - 1,
        y: -((e.clientY - rect.top)/rect.height)*2 + 1
      };
    }

    renderer.domElement.addEventListener("pointerdown", (e)=>{
      if(state.mode !== "3d") return;
      if(!shiftDown) return;

      const m = getMouse(e);
      raycaster.setFromCamera(m, camera);
      const hits = raycaster.intersectObjects(hitMeshes);
      if(hits.length){
        dragging = true;
        draggedGroup = hits[0].object.userData.parentGroup;
        controls.enabled = false;
        tooltip.style.display = "none";
        renderer.domElement.style.cursor = "grabbing";
        const p = new THREE.Vector3();
        raycaster.ray.intersectPlane(dragPlane, p);
        dragOffset.copy(p).sub(draggedGroup.position);
      }
    });

    renderer.domElement.addEventListener("pointermove", (e)=>{
      if(state.mode !== "3d") return;

      const m = getMouse(e);
      raycaster.setFromCamera(m, camera);

      if(dragging && draggedGroup){
        const p = new THREE.Vector3();
        raycaster.ray.intersectPlane(dragPlane, p);
        draggedGroup.position.copy(p.sub(dragOffset));
        return;
      }

      const hits = raycaster.intersectObjects(hitMeshes);
      if(shiftDown && hits.length){
        renderer.domElement.style.cursor = "grab";
      }else{
        renderer.domElement.style.cursor = "auto";
      }

      if(hits.length){
        const u = hits[0].object.userData.parentGroup.userData;
        tooltip.innerHTML = `
          <b>${u.name}</b>
          <div class="row"><span class="lbl">ì¹˜ìˆ˜</span><span class="val">${u.w}Ã—${u.d}Ã—${u.h} m</span></div>
          <div class="row"><span class="lbl">ë°”ë‹¥</span><span class="val">${u.metrics.floor.toFixed(2)} ã¡</span></div>
          <div class="row"><span class="lbl">ë‘˜ë ˆ</span><span class="val">${u.metrics.perim.toFixed(2)} m</span></div>
          <div class="row"><span class="lbl">ë²½ë©´ì </span><span class="val">${u.metrics.wall.toFixed(2)} ã¡</span></div>
          ${state.windowsEnabled ? `
            <div class="row"><span class="lbl">ì°½ë©´ì </span><span class="val">-${u.metrics.win.toFixed(2)} ã¡</span></div>
            <div class="row"><span class="lbl">ì‹¤ë²½ë©´ì </span><span class="val">${u.metrics.netWall.toFixed(2)} ã¡</span></div>
          ` : ``}
        `;
        tooltip.style.display = "block";
        tooltip.style.left = (e.clientX + 14) + "px";
        tooltip.style.top  = (e.clientY + 14) + "px";
      }else{
        tooltip.style.display = "none";
      }
    });

    function endDrag(){
      if(dragging && draggedGroup){
        const t = draggedGroup.userData.targetPos;
        if(t && draggedGroup.position.distanceTo(t) < 0.6){
          draggedGroup.position.copy(t);
        }
      }
      dragging = false;
      draggedGroup = null;
      controls.enabled = true;
      renderer.domElement.style.cursor = shiftDown ? "grab" : "auto";
    }

    renderer.domElement.addEventListener("pointerup", endDrag);
    renderer.domElement.addEventListener("pointerleave", endDrag);

    // =========================
    // 5) ë¹Œë“œ/ìº¡ì²˜/ë‚´ë³´ë‚´ê¸°/ë³µì‚¬(JSON)
    // =========================
    function switchMode(mode){
      if(state.mode === "2d") save2DPositions();
      state.mode = mode;

      if(mode === "2d"){
        el("tab2D").classList.add("active");
        el("tab3D").classList.remove("active");
        twodContainer.style.display = "block";
        el("three-container").style.display = "none";
        tooltip.style.display = "none";
        build2DScene();
      }else{
        el("tab3D").classList.add("active");
        el("tab2D").classList.remove("active");
        twodContainer.style.display = "none";
        el("three-container").style.display = "block";
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        if(state.rooms.length) build3DScene();
      }
      save();
    }

    function build(){
      const cleaned = [];
      state.rooms.forEach(r=>{
        const rr = normalizeRoom(r);
        if(rr.name && rr.w>0 && rr.d>0) cleaned.push(rr);
      });
      state.rooms = cleaned;
      save();
      renderTable();
      if(state.mode === "2d") build2DScene(); else build3DScene();
      showToast("ë„ë©´ ìƒì„± ì™„ë£Œ âœ…");
    }

    function capture(){
      if(state.mode === "2d"){
        html2canvas(twodContainer).then(canvas=>{
          const a = document.createElement("a");
          a.download = "yugy_2D.png";
          a.href = canvas.toDataURL("image/png");
          a.click();
        });
      }else{
        renderer.render(scene, camera);
        const a = document.createElement("a");
        a.download = "yugy_3D.png";
        a.href = renderer.domElement.toDataURL("image/png");
        a.click();
      }
    }

    function buildPayload(){
      // ë°©ë³„ ê¸°ë³¸ ë©”íŠ¸ë¦­ í¬í•¨
      const rooms = state.rooms.map(r=>{
        const perim = (r.w + r.d) * 2;
        const floor = r.w * r.d;
        const wall = perim * r.h;
        const win = state.windowsEnabled ? (["A","B","C","D"].reduce((sum,k)=>{
          const ww = r.win?.[k]?.w||0;
          const wh = r.win?.[k]?.h||0;
          return sum + (ww>0&&wh>0 ? ww*wh : 0);
        },0)) : 0;

        return {
          id: r.id,
          name: r.name,
          w_m: r.w,
          d_m: r.d,
          h_m: r.h,
          metrics: {
            floor_m2: Number(floor.toFixed(3)),
            perim_m: Number(perim.toFixed(3)),
            wall_m2: Number(wall.toFixed(3)),
            window_m2: Number(win.toFixed(3)),
            netWall_m2: Number(Math.max(0, wall-win).toFixed(3))
          },
          windows: state.windowsEnabled ? r.win : undefined
        };
      });

      return {
        kind: "yugy.rooms",
        version: VERSION,
        exportedAt: new Date().toISOString(),
        windowsEnabled: !!state.windowsEnabled,
        rooms
      };
    }

    async function copyTextToClipboard(text){
      // 1) ìµœì‹  ë¸Œë¼ìš°ì €
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
      // 2) fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }

    async function copyJSONForTalk(){
      if(!state.rooms.length){
        alert("ë¨¼ì € ë°© ë°ì´í„°ë¥¼ ë„£ê³  â€˜ë„ë©´ ìƒì„±â€™ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
        return;
      }
      const payload = buildPayload();
      const text = JSON.stringify(payload, null, 2);

      try{
        const ok = await copyTextToClipboard(text);
        if(!ok) throw new Error("copy failed");
        showToast("ë³µì‚¬ ì™„ë£Œ! âœ… í†¡í†¡ì— ë¶™ì—¬ë„£ê³  â€˜1ì°¨ ë¦¬í¬íŠ¸ ìš”ì²­â€™ ë³´ë‚´ì„¸ìš”");
        // ì‚¬ìš©ìê°€ ì›í•˜ë©´ í†¡í†¡ì„ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ì–´ì¤€ë‹¤
        window.open(TALK_URL, "_blank");
      }catch(e){
        alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”.\nì•„ë˜ JSON íŒŒì¼ì„ ë‹¤ìš´ë°›ì•„ ì§ì ‘ ë³´ë‚´ì£¼ì„¸ìš”.");
        downloadJSON();
      }
    }

    function downloadJSON(){
      const payload = buildPayload();
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "yugy_rooms.json";
      a.click();
      URL.revokeObjectURL(url);
      showToast("JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ âœ…");
    }

    // =========================
    // 6) ë²„íŠ¼/ì´ë²¤íŠ¸
    // =========================
    el("tab2D").addEventListener("click", ()=>switchMode("2d"));
    el("tab3D").addEventListener("click", ()=>switchMode("3d"));

    el("btnAddRoom").addEventListener("click", ()=>{
      state.rooms.push(normalizeRoom({id:autoId(), name:"", w:0, d:0, h:2.3}));
      save();
      renderTable();
      showToast("ë°© ì¶”ê°€ë¨ âœ…");
    });

    el("btnToggleWindows").addEventListener("click", ()=>{
      state.windowsEnabled = !state.windowsEnabled;
      state.rooms.forEach(r=>{
        r.win ||= {A:{w:0,h:0},B:{w:0,h:0},C:{w:0,h:0},D:{w:0,h:0}};
      });
      save();
      renderTable();
      build(); // ì¦‰ì‹œ ë°˜ì˜
      showToast(state.windowsEnabled ? "ì°½ë¬¸ ì…ë ¥ ON ğŸªŸ" : "ì°½ë¬¸ ì…ë ¥ OFF");
    });

    el("btnLoadFromPaste").addEventListener("click", ()=>{
      const rooms = loadFromPaste(el("pasteBox").value);
      if(!rooms.length){
        alert("ë¶™ì—¬ë„£ê¸° ë°ì´í„°ì—ì„œ ë°©ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”.\ní˜•ì‹: ID, ë°©ì´ë¦„, ê°€ë¡œ, ì„¸ë¡œ, (ì„ íƒ)ë†’ì´");
        return;
      }
      const old = new Map(state.rooms.map(r=>[r.id, r]));
      const merged = rooms.map(r=>{
        const prev = old.get(r.id);
        if(prev){
          r.x2d = prev.x2d ?? null;
          r.y2d = prev.y2d ?? null;
          r.win = prev.win ?? r.win;
        }
        return r;
      });
      state.rooms = merged;
      save();
      renderTable();
      build();
    });

    el("btnSample").addEventListener("click", ()=>{
      el("pasteBox").value =
`1\tê±°ì‹¤\t5.0\t4.0\t2.3
2\tì¹¨ì‹¤1\t3.2\t3.0\t2.3
3\tì¹¨ì‹¤2\t3.0\t2.8\t2.3
4\tì£¼ë°©\t3.0\t2.6\t2.3
5\tìš•ì‹¤\t2.2\t1.8\t2.3`;
      showToast("ìƒ˜í”Œ ì…ë ¥ë¨ âœ…");
    });

    el("btnBuild").addEventListener("click", build);
    el("btnCapture").addEventListener("click", capture);

    el("btnCopyJson").addEventListener("click", copyJSONForTalk);
    el("btnDownloadJson").addEventListener("click", downloadJSON);

    el("btnReset").addEventListener("click", ()=>{
      if(!confirm("ì§„ì§œ ì´ˆê¸°í™”í• ê¹Œìš”?\n(í˜„ì¬ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)")) return;
      localStorage.removeItem(STORAGE_KEY);
      state.rooms = [];
      state.windowsEnabled = false;
      el("pasteBox").value = "";
      save();
      renderTable();
      build2DScene();
      clear3D();
      setStatus("ì´ˆê¸°í™”ë¨ âœ…");
      showToast("ì´ˆê¸°í™” ì™„ë£Œ âœ…");
    });

    // í‚¤ë³´ë“œ: P ìº¡ì²˜ / Shift ë“œë˜ê·¸
    window.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if(k === "shift") shiftDown = true;
      if(k === "p") capture();
    });
    window.addEventListener("keyup", (e)=>{
      if(e.key === "Shift"){
        shiftDown = false;
        renderer.domElement.style.cursor = "auto";
      }
    });

    // ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€
    el("fab").addEventListener("click", ()=>{
      document.body.classList.toggle("menu-collapsed");
    });

    window.addEventListener("resize", ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      if(state.mode === "2d") build2DScene();
    });

    // =========================
    // 7) ë Œë” ë£¨í”„
    // =========================
    function animate(){
      requestAnimationFrame(animate);
      if(state.mode === "3d"){
        controls.update();
        renderer.render(scene, camera);
      }
    }

    // =========================
    // 8) ì‹œì‘
    // =========================
    load();
    if(!state.rooms) state.rooms = [];
    state.rooms = (state.rooms||[]).map(normalizeRoom);
    renderTable();
    switchMode(state.mode || "3d");
    setStatus("ë¡œë“œë¨ âœ…");
    animate();

  </script>
</body>
</html>
