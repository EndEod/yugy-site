<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YUGY.ORG - ê±´ì¶• í†µí•© ì†”ë£¨ì…˜ v2.2</title>
  <style>
    /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
    body { margin: 0; overflow: hidden; font-family: 'Malgun Gothic', sans-serif; background: #f0f0f0; user-select: none; }
    
    /* === UI íŒ¨ë„ === */
    #ui-container {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255, 255, 255, 0.96);
      padding: 16px; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      width: 360px; z-index: 100;
      max-height: 90vh; overflow-y: auto;
      border: 1px solid #ddd;
      display: flex; flex-direction: column; gap: 8px;
    }
    h3 { margin: 0 0 4px 0; color: #333; font-size: 18px; display: flex; align-items: center; justify-content: space-between; }
    .badge { background: #333; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; vertical-align: middle; }
    
    /* === íƒ­ ë²„íŠ¼ === */
    .tab-container { display: flex; gap: 5px; margin-bottom: 4px; }
    .tab-btn {
      flex: 1; padding: 8px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: bold; font-size: 13px; transition: all 0.2s;
    }
    .tab-btn.active { background: #333; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .tab-btn.inactive { background: #e0e0e0; color: #777; }
    .tab-btn.inactive:hover { background: #d0d0d0; }

    textarea { width: 100%; height: 100px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; box-sizing: border-box; resize: vertical; }
    
    /* === ë²„íŠ¼ ìŠ¤íƒ€ì¼ === */
    #buildBtn {
      width: 100%; padding: 12px; background: #007bff; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 5px;
    }
    #buildBtn:hover { background: #0056b3; }

    #storeBtn {
      display: block; width: 100%; padding: 12px; background: #03C75A; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; text-align: center; text-decoration: none;
      box-sizing: border-box; margin-top: 5px; box-shadow: 0 2px 5px rgba(3, 199, 90, 0.3); transition: background 0.2s;
    }
    #storeBtn:hover { background: #02b351; }

    #info { font-size: 12px; color: #555; line-height: 1.4; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 5px;}
    kbd { background:#fff; border:1px solid #ccc; padding:1px 5px; border-radius:4px; font-family: monospace; font-weight: bold;}
    .caution { color: #d9534f; font-weight: bold; }

    /* === ë·°ì–´ ì˜ì—­ === */
    #viewer-area { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    #three-container { width: 100%; height: 100%; display: block; }

    /* === 2D ëª¨ë“œ ìŠ¤íƒ€ì¼ (ì—…ë°ì´íŠ¸ë¨) === */
    #twod-container {
      width: 100%; height: 100%; overflow: auto; display: none;
      background: #fff; position: relative;
      background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px);
      background-size: 40px 40px; /* ê·¸ë¦¬ë“œ ê°„ê²© */
    }
    .room-2d {
      position: absolute; border: 2px solid #666;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 12px; color: #000; cursor: grab; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      touch-action: none; /* ëª¨ë°”ì¼ ë“œë˜ê·¸ ì§€ì› */
    }
    .room-2d.dragging { cursor: grabbing; opacity: 0.8; z-index: 999; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); }
    .room-2d b { font-size: 14px; margin-bottom: 4px; }
    
    .wall-section-title {
        position: absolute; font-weight: bold; font-size: 18px; color: #333; padding: 10px;
        border-bottom: 2px solid #333; width: 90%; left: 20px;
    }

</style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>

  <div id="ui-container">
    <h3>ì—¬ê¸°ê±´ì¶•ì‚¬ì‚¬ë¬´ì†Œ <span class="badge">v2.2</span></h3>
    
    <div class="tab-container">
      <button id="tab2D" class="tab-btn inactive">ğŸ“Š ì—‘ì…€ í‚¤íŠ¸(2D)</button>
      <button id="tab3D" class="tab-btn active">ğŸ§Š 3D íˆ¬ì‹œë„</button>
    </div>

    <div class="hint" style="font-size:11px; color:#888;">ì—‘ì…€ ë°ì´í„°ë¥¼ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>
    <textarea id="dataInput" placeholder="ì˜ˆì‹œ ë°ì´í„°)
1	ê±°ì‹¤	5.0	4.0	20.0	20.0	18.0	2.4	43.2
2	ì¹¨ì‹¤	3.5	3.0	10.5	10.5	13.0	2.4	31.2"></textarea>

    <button id="buildBtn">ğŸ—ï¸ ë„ë©´ ìƒì„±í•˜ê¸° (Build)</button>

    <div id="info">
      <div class="caution" style="margin-bottom: 8px;">â€» ìƒˆë¡œê³ ì¹¨(F5)í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤!</div>
      <div id="info-2d" style="display:none;">
        <b>[2D ëª¨ë“œ ì•ˆë‚´]</b><br/>
        âœ… <kbd>í´ë¦­+ë“œë˜ê·¸</kbd>: ë°© ì¡°ê° ì´ë™<br/>
        âœ… ë§ˆìš°ìŠ¤ íœ : í™”ë©´ ìŠ¤í¬ë¡¤<br/>
        âœ… ì•„ë˜ìª½ì— ë²½ì²´ ì „ê°œë„ë„ ìˆì–´ìš”.
      </div>
      <div id="info-3d">
        <b>[3D ëª¨ë“œ ì•ˆë‚´]</b><br/>
        âœ… <kbd>Shift</kbd> + ë“œë˜ê·¸: ë°© ì´ë™<br/>
        âœ… ì™¼ìª½í´ë¦­: íšŒì „ / ì˜¤ë¥¸ìª½: ì´ë™ / íœ : ì¤Œ<br/>
        âœ… <kbd>L</kbd>: ê¸€ì”¨(ë¼ë²¨) ë„ê¸°/ì¼œê¸° âœ¨<br/>
        âœ… <kbd>P</kbd>: í˜„ì¬ í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸<br/>
        âœ… <kbd>G</kbd>: ì •ë‹µ ìœ ë ¹ ìˆ¨ê¸°ê¸°/ë³´ê¸°
      </div>
    </div>

    <a href="https://smartstore.naver.com/kiendeod_susutto" target="_blank" id="storeBtn">
      ğŸ›ï¸ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ êµ¬ê²½ê°€ê¸°
    </a>
  </div>

  <div id="viewer-area">
    <div id="twod-container"></div>
    <div id="three-container"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ==========================================
    // 1. ê³µí†µ ë°ì´í„° ë° ìœ í‹¸ë¦¬í‹°
    // ==========================================
    const EXCEL_COLORS = [
      "#FFCCCC", "#FFE5CC", "#FFFFCC", "#E5FFCC", "#CCFFCC", "#CCFFE5", "#CCFFFF", "#CCE5FF", "#CCCCFF", "#E5CCFF",
      "#FFCCFF", "#FFCCE5", "#FFB2B2", "#FFD6A5", "#FFEF9F", "#CAE799", "#A6E3A1", "#99DDCC", "#9FDBFF", "#ADC1FF",
      "#C8B2FF", "#E0B2FF", "#FFB2F5", "#FFB2D7", "#FFB2B2", "#FF8282", "#FFAA64", "#FFD246", "#B4DC5A", "#78D296"
    ];

    let globalData = [];
    let currentMode = '3d';

    function splitCols(line) {
      const t = (line || '').trim();
      if (!t) return null;
      if (t.includes('ê³µê°„ID') || t.includes('ê³µê°„ëª…')) return null;
      if (t.includes('\t')) return t.split('\t').map(s => s.trim());
      if (t.includes(',')) return t.split(',').map(s => s.trim());
      return t.split(/\s+/).map(s => s.trim());
    }

    function parseData() {
      const input = document.getElementById('dataInput').value || '';
      const lines = input.split(/\r?\n/);
      const parsed = [];
      lines.forEach(line => {
        const cols = splitCols(line);
        if (!cols) return;
        if (cols.length >= 4 && !isNaN(Number(cols[0])) && cols[1]) {
          const id = parseInt(cols[0], 10);
          const name = cols[1];
          const w = parseFloat(cols[2]);
          const d = parseFloat(cols[3]);
          const h = parseFloat(cols[7]) || 2.4;
          if ([w, d].every(Number.isFinite)) {
            parsed.push({ id, name, w, d, h });
          }
        }
      });
      globalData = parsed;
      return parsed;
    }

    // ==========================================
    // 2. 2D ëª¨ë“œ (DOM Element ë°©ì‹ - ë“œë˜ê·¸ ê°€ëŠ¥!)
    // ==========================================
    const twodContainer = document.getElementById('twod-container');
    const SCALE_2D = 40; // 1m = 40px

    // 2D ë“œë˜ê·¸ ê´€ë ¨ ë³€ìˆ˜
    let active2DItem = null;
    let active2DOffset = { x: 0, y: 0 };

    twodContainer.addEventListener('pointerdown', dragStart2D);
    twodContainer.addEventListener('pointermove', drag2D);
    twodContainer.addEventListener('pointerup', dragEnd2D);
    twodContainer.addEventListener('pointerleave', dragEnd2D);

    function dragStart2D(e) {
      const target = e.target.closest('.room-2d.draggable');
      if (!target) return;
      active2DItem = target;
      active2DItem.classList.add('dragging');
      const rect = active2DItem.getBoundingClientRect();
      // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ ê³„ì‚°
      const containerRect = twodContainer.getBoundingClientRect();
      active2DOffset.x = e.clientX - rect.left;
      active2DOffset.y = e.clientY - rect.top;
    }

    function drag2D(e) {
        if (!active2DItem) return;
        e.preventDefault();
        const containerRect = twodContainer.getBoundingClientRect();
        // ìŠ¤í¬ë¡¤ ê°ì•ˆí•œ í˜„ì¬ ì»¨í…Œì´ë„ˆ ë‚´ ë§ˆìš°ìŠ¤ ìœ„ì¹˜
        const currentX = e.clientX - containerRect.left + twodContainer.scrollLeft;
        const currentY = e.clientY - containerRect.top + twodContainer.scrollTop;
        
        active2DItem.style.left = (currentX - active2DOffset.x) + 'px';
        active2DItem.style.top = (currentY - active2DOffset.y) + 'px';
    }

    function dragEnd2D(e) {
      if (!active2DItem) return;
      active2DItem.classList.remove('dragging');
      active2DItem = null;
    }

    function build2DScene() {
      twodContainer.innerHTML = ''; // ì´ˆê¸°í™”
      if (!globalData.length) return;

      let cursorY = 60;
      const startX = 50;

      // 1. ë°”ë‹¥ í‰ë©´ë„ íƒ€ì´í‹€
      const title1 = document.createElement('div');
      title1.className = 'wall-section-title';
      title1.innerText = '1. ë°”ë‹¥ í‰ë©´ë„ (ë“œë˜ê·¸í•´ì„œ ë§ì¶°ë³´ì„¸ìš”!)';
      title1.style.top = '10px';
      twodContainer.appendChild(title1);

      globalData.forEach((d, idx) => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#ddd";
        const wPx = d.w * SCALE_2D;
        const dPx = d.d * SCALE_2D;

        // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë°© DIV ìƒì„±
        const roomDiv = document.createElement('div');
        roomDiv.className = 'room-2d draggable';
        roomDiv.style.width = wPx + 'px';
        roomDiv.style.height = dPx + 'px';
        roomDiv.style.backgroundColor = color;
        roomDiv.style.left = startX + 'px';
        roomDiv.style.top = cursorY + 'px';
        roomDiv.innerHTML = `<b>${d.name}</b><span>(${d.w} x ${d.d})</span>`;
        
        twodContainer.appendChild(roomDiv);
        cursorY += dPx + 30; // ë‹¤ìŒ ìœ„ì¹˜ ì¡ì•„ë‘ê¸° (ì´ˆê¸°ë°°ì¹˜ìš©)
      });

      // 2. ë²½ì²´ ì „ê°œë„ ì„¹ì…˜ (êµ¬ë¶„ì„  ë° íƒ€ì´í‹€)
      let wallStartY = Math.max(cursorY + 50, 600); // ìµœì†Œ ë†’ì´ ë³´ì¥
      
      const title2 = document.createElement('div');
      title2.className = 'wall-section-title';
      title2.innerText = '2. ë²½ì²´ ì „ê°œë„ (ê³ ì •ë¨)';
      title2.style.top = wallStartY + 'px';
      twodContainer.appendChild(title2);

      wallStartY += 60;

      // ë²½ì²´ ì „ê°œë„ ê·¸ë¦¬ê¸° (ì´ê±´ ê³ ì •)
      globalData.forEach(d => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#ddd";
        const hPx = d.h * SCALE_2D;
        let currentX = 50;
        
        // ë£¸ ì´ë¦„ ë¼ë²¨
        const roomLabel = document.createElement('div');
        roomLabel.style.position = 'absolute';
        roomLabel.style.fontWeight = 'bold';
        roomLabel.style.top = (wallStartY + hPx/2 - 10) + 'px';
        roomLabel.style.left = '20px';
        roomLabel.innerText = `[${d.name}] H:${d.h}m`;
        twodContainer.appendChild(roomLabel);
        
        currentX = 160;

        const walls = [
          { name: "ë²½-A(ì•)", len: d.w }, { name: "ë²½-B(ìš°)", len: d.d },
          { name: "ë²½-C(ë’¤)", len: d.w }, { name: "ë²½-D(ì¢Œ)", len: d.d }
        ];

        walls.forEach(w => {
            const wLenPx = w.len * SCALE_2D;
            const wallDiv = document.createElement('div');
            wallDiv.className = 'room-2d'; // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ê³µìœ  (ë“œë˜ê·¸ëŠ” ì•ˆë¨)
            wallDiv.style.width = wLenPx + 'px';
            wallDiv.style.height = hPx + 'px';
            wallDiv.style.backgroundColor = color;
            wallDiv.style.left = currentX + 'px';
            wallDiv.style.top = wallStartY + 'px';
            wallDiv.innerHTML = `<span>${w.name}</span><span style="font-size:10px">(${w.len}x${d.h})</span>`;
            twodContainer.appendChild(wallDiv);
            currentX += wLenPx + 10;
        });
        wallStartY += hPx + 50;
      });
      
      // ì»¨í…Œì´ë„ˆ ë†’ì´ ëŠ˜ë ¤ì£¼ê¸° (ìŠ¤í¬ë¡¤ í™•ë³´)
      const finalSpacer = document.createElement('div');
      finalSpacer.style.position = 'absolute';
      finalSpacer.style.top = wallStartY + 'px';
      finalSpacer.style.height = '100px';
      finalSpacer.style.width = '10px';
      twodContainer.appendChild(finalSpacer);
    }


    // ==========================================
    // 3. 3D íˆ¬ì‹œë„ ëª¨ë“œ (Three.js)
    // ==========================================
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(12, 12, 16); camera.lookAt(0, 0, 0);
    const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true }); // ìº¡ì²˜ë¥¼ ìœ„í•´ ë²„í¼ ë³´ì¡´
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('three-container').appendChild(renderer.domElement);
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(50, 80, 50); dirLight.castShadow = true; scene.add(dirLight);
    const controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true;
    const gridHelper = new THREE.GridHelper(100, 100, 0xbbbbbb, 0xeeeeee); scene.add(gridHelper);

    let pieces = []; let ghosts = []; let hitMeshes = [];
    // âœ¨ 3D ë¼ë²¨ ê´€ë¦¬ìš© ë°°ì—´
    let labels3D = []; 
    let labelsVisible = true;

    const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    const dragPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
    let dragging = false, draggedGroup = null; let dragOffset = new THREE.Vector3();
    let shiftDown = false; let ghostsVisible = true;

    function create3DRoom(d, colorHex) {
      const group = new THREE.Group();
      const w = d.w; const depth = d.d; const h = d.h;
      const matColor = new THREE.Color(colorHex);
      const floorGeo = new THREE.PlaneGeometry(w, depth);
      const floorMat = new THREE.MeshStandardMaterial({ color: matColor, side: THREE.DoubleSide });
      const floor = new THREE.Mesh(floorGeo, floorMat);
      floor.rotation.x = -Math.PI/2; floor.position.y = 0.01; floor.receiveShadow = true; group.add(floor);
      const wallMat = new THREE.MeshStandardMaterial({ color: matColor, roughness: 0.7 });
      const wallThick = 0.1;
      const w1 = new THREE.Mesh(new THREE.BoxGeometry(w, h, wallThick), wallMat); w1.position.set(0, h/2, -depth/2); group.add(w1);
      const w2 = w1.clone(); w2.position.set(0, h/2, depth/2); group.add(w2);
      const w3 = new THREE.Mesh(new THREE.BoxGeometry(depth, h, wallThick), wallMat); w3.rotation.y = Math.PI/2; w3.position.set(-w/2, h/2, 0); group.add(w3);
      const w4 = w3.clone(); w4.rotation.y = Math.PI/2; w4.position.set(w/2, h/2, 0); group.add(w4);

      // ë¼ë²¨ ìƒì„±
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.font = 'bold 40px Malgun Gothic';
      const textWidth = ctx.measureText(d.name).width + 50;
      canvas.width = textWidth; canvas.height = 110;
      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle = '#333'; ctx.lineWidth = 5; ctx.strokeRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(d.name, canvas.width/2, 35);
      ctx.font = '26px Malgun Gothic';
      ctx.fillText(`(${d.w}x${d.d})`, canvas.width/2, 80);
      const tex = new THREE.CanvasTexture(canvas);
      const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
      label.scale.set(textWidth/20, 5.5, 1);
      label.position.set(0, h + 2, 0);
      group.add(label);
      // âœ¨ ë¼ë²¨ ê´€ë¦¬ ë°°ì—´ì— ì¶”ê°€
      labels3D.push(label);

      const hitMesh = new THREE.Mesh(new THREE.PlaneGeometry(w, depth), new THREE.MeshBasicMaterial({visible:false}));
      hitMesh.rotation.x = -Math.PI/2; hitMesh.position.y = 0.1; hitMesh.userData.parentGroup = group;
      group.add(hitMesh); hitMeshes.push(hitMesh);
      group.userData = { id: d.id, w: d.w, d: d.d, h: d.h, targetPos: new THREE.Vector3() };
      return group;
    }

    function build3DScene() {
      pieces.forEach(p => scene.remove(p)); ghosts.forEach(g => scene.remove(g));
      pieces = []; ghosts = []; hitMeshes = []; labels3D = []; // ì´ˆê¸°í™”
      let x = 0, z = 0, rowH = 0; const LIMIT = 25;
      globalData.forEach((d, idx) => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#cccccc";
        const group = create3DRoom(d, color);
        if (x + d.w > LIMIT) { x = 0; z += rowH + 0.5; rowH = 0; }
        group.userData.targetPos.set(x + d.w/2, 0, z + d.d/2);
        x += d.w + 0.5; rowH = Math.max(rowH, d.d);
        const ghostGeo = new THREE.PlaneGeometry(d.w, d.d);
        const ghostMat = new THREE.MeshBasicMaterial({ color: 0x000000, opacity: 0.15, transparent: true, side: THREE.DoubleSide });
        const ghost = new THREE.Mesh(ghostGeo, ghostMat);
        ghost.rotation.x = -Math.PI/2; ghost.position.copy(group.userData.targetPos); ghost.position.y = 0.005;
        scene.add(ghost); ghosts.push(ghost);
        group.position.set(group.userData.targetPos.x + (Math.random()-0.5)*15, 0, group.userData.targetPos.z + 8 + Math.random()*8);
        scene.add(group); pieces.push(group);
      });
    }

    // ==========================================
    // 4. ì´ë²¤íŠ¸ ë° í†µí•© ë¡œì§
    // ==========================================
    const tab2D = document.getElementById('tab2D');
    const tab3D = document.getElementById('tab3D');
    const info2D = document.getElementById('info-2d');
    const info3D = document.getElementById('info-3d');
    const threeContainerEl = document.getElementById('three-container');

    function switchMode(mode) {
      currentMode = mode;
      if (mode === '2d') {
        tab2D.className = 'tab-btn active'; tab3D.className = 'tab-btn inactive';
        twodContainer.style.display = 'block';
        threeContainerEl.style.display = 'none';
        info2D.style.display = 'block'; info3D.style.display = 'none';
        build2DScene();
      } else {
        tab3D.className = 'tab-btn active'; tab2D.className = 'tab-btn inactive';
        twodContainer.style.display = 'none';
        threeContainerEl.style.display = 'block';
        info2D.style.display = 'none'; info3D.style.display = 'block';
        if (globalData.length > 0 && pieces.length === 0) build3DScene();
        // 3D ëª¨ë“œ ì§„ì… ì‹œ ë Œë”ëŸ¬ ì‚¬ì´ì¦ˆ ì¬ì¡°ì • (ì•ˆì „ì¥ì¹˜)
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      }
    }
    tab2D.addEventListener('click', () => switchMode('2d'));
    tab3D.addEventListener('click', () => switchMode('3d'));

    document.getElementById('buildBtn').addEventListener('click', () => {
      parseData();
      if (globalData.length === 0) { alert("ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!"); return; }
      if (currentMode === '2d') build2DScene(); else build3DScene();
    });

    // âœ¨ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (L:ë¼ë²¨, P:ìº¡ì²˜, G:ìœ ë ¹, Shift:ë“œë˜ê·¸)
    window.addEventListener('keydown', e => {
        const key = e.key.toLowerCase();
        if(key === 'shift') shiftDown = true;
        
        if(currentMode === '3d') {
            if(key === 'g') {
                ghostsVisible = !ghostsVisible;
                ghosts.forEach(g => g.visible = ghostsVisible);
            }
            // âœ¨ Lí‚¤: ë¼ë²¨ í† ê¸€
            if(key === 'l') {
                labelsVisible = !labelsVisible;
                labels3D.forEach(l => l.visible = labelsVisible);
            }
            // âœ¨ Pí‚¤: ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜
            if(key === 'p') {
                renderScene(); // ìº¡ì²˜ ì „ í•œë²ˆ ê·¸ë ¤ì£¼ê¸°
                const dataURL = renderer.domElement.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'room_capture.png';
                link.href = dataURL;
                link.click();
            }
        }
    });
    window.addEventListener('keyup', e => { if(e.key==='Shift') shiftDown=false; });

    // 3D ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
    threeContainerEl.addEventListener('pointerdown', onPointerDown);
    threeContainerEl.addEventListener('pointermove', onPointerMove);
    threeContainerEl.addEventListener('pointerup', onPointerUp);
    function onPointerDown(e) {
      if(!shiftDown || currentMode !== '3d') return;
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((e.clientX - rect.left)/rect.width)*2 - 1;
      mouse.y = -((e.clientY - rect.top)/rect.height)*2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(hitMeshes);
      if(intersects.length > 0) {
        dragging = true; draggedGroup = intersects[0].object.userData.parentGroup;
        controls.enabled = false;
        raycaster.ray.intersectPlane(dragPlane, dragOffset);
        dragOffset.sub(draggedGroup.position);
      }
    }
    function onPointerMove(e) {
      if(!dragging || !draggedGroup) return;
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((e.clientX - rect.left)/rect.width)*2 - 1;
      mouse.y = -((e.clientY - rect.top)/rect.height)*2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersectPoint = new THREE.Vector3();
      raycaster.ray.intersectPlane(dragPlane, intersectPoint);
      draggedGroup.position.copy(intersectPoint.sub(dragOffset));
    }
    function onPointerUp() {
      if(dragging && draggedGroup) {
        const t = draggedGroup.userData.targetPos;
        if(draggedGroup.position.distanceTo(t) < 0.5) draggedGroup.position.copy(t);
      }
      dragging = false; draggedGroup = null; controls.enabled = true;
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      if(currentMode === '2d') build2DScene();
    });

    function renderScene() { renderer.render(scene, camera); }
    function animate() {
      requestAnimationFrame(animate);
      if(currentMode === '3d') { controls.update(); renderScene(); }
    }
    animate();
    switchMode('3d'); // ì´ˆê¸° ëª¨ë“œ

  </script>
</body>
</html>
