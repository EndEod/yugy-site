<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; background: #f0f0f0; user-select: none; }
    
    /* === UI íŒ¨ë„ === */
    #ui-container {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255, 255, 255, 0.96);
      padding: 16px; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      width: 360px; z-index: 100;
      max-height: 90vh; overflow-y: auto;
      border: 1px solid #ddd;
      display: flex; flex-direction: column; gap: 8px;
    }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    h3 { margin: 0; color: #333; font-size: 18px; display: flex; align-items: center; gap: 6px; }
    .badge { background: #333; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; vertical-align: middle; }
    
    #langBtn {
      background: none; border: 1px solid #ccc; border-radius: 20px;
      padding: 4px 10px; font-size: 12px; cursor: pointer;
      display: flex; align-items: center; gap: 4px; transition: all 0.2s;
    }
    #langBtn:hover { background: #eee; border-color: #999; }

    .tab-container { display: flex; gap: 5px; margin-bottom: 4px; }
    .tab-btn {
      flex: 1; padding: 8px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: bold; font-size: 13px; transition: all 0.2s;
    }
    .tab-btn.active { background: #333; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .tab-btn.inactive { background: #e0e0e0; color: #777; }
    .tab-btn.inactive:hover { background: #d0d0d0; }

    textarea { width: 100%; height: 80px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; box-sizing: border-box; resize: vertical; }
    
    #buildBtn {
      width: 100%; padding: 12px; background: #007bff; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 5px;
    }
    #buildBtn:hover { background: #0056b3; }

    /* ë§í¬ ë²„íŠ¼ ê·¸ë£¹ */
    .link-group { display: flex; gap: 5px; margin-top: 5px; }
    .link-btn {
        flex: 1; padding: 8px; font-size: 11px; text-decoration: none; color: #333;
        border: 1px solid #ccc; border-radius: 6px; text-align: center; background: #fff;
        transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px;
    }
    .link-btn:hover { background: #f5f5f5; }
    .link-btn img { height: 14px; }

    #storeBtn {
      display: block; width: 100%; padding: 12px; background: #03C75A; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; text-align: center; text-decoration: none;
      box-sizing: border-box; margin-top: 5px; box-shadow: 0 2px 5px rgba(3, 199, 90, 0.3); transition: background 0.2s;
    }
    #storeBtn:hover { background: #02b351; }

    #info { font-size: 12px; color: #555; line-height: 1.4; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 5px;}
    kbd { background:#fff; border:1px solid #ccc; padding:1px 5px; border-radius:4px; font-family: monospace; font-weight: bold;}
    .caution { color: #d9534f; font-weight: bold; }

    /* === íˆ´íŒ ìŠ¤íƒ€ì¼ === */
    #tooltip {
      position: fixed; z-index: 9999; display: none; pointer-events: none;
      background: rgba(20, 20, 20, 0.95); color: #fff;
      padding: 12px 16px; border-radius: 8px;
      font-size: 13px; line-height: 1.6;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);
      min-width: 200px;
    }
    #tooltip b { font-size: 15px; color: #ffd700; display: block; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px;}
    #tooltip .row { display: flex; justify-content: space-between; gap: 15px; }
    #tooltip .val { font-weight: bold; color: #fff; }
    #tooltip .lbl { color: #aaa; }

    /* === ë·°ì–´ ì˜ì—­ === */
    #viewer-area { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    #three-container { width: 100%; height: 100%; display: block; cursor: auto; }
    #twod-container {
      width: 100%; height: 100%; overflow: auto; display: none;
      background: #fff; position: relative;
      background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px);
      background-size: 40px 40px; 
    }
    .room-2d {
      position: absolute; border: 2px solid #666;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 12px; color: #000; cursor: grab; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      touch-action: none; 
    }
    .room-2d.dragging { cursor: grabbing; opacity: 0.8; z-index: 999; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); }
    .wall-section-title {
        position: absolute; font-weight: bold; font-size: 18px; color: #333; padding: 10px;
        border-bottom: 2px solid #333; width: auto; left: 400px; right: 20px; 
    }
    .wall-section-title.unfolding { left: 20px; width: 90%; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>

  <div id="tooltip"></div>

  <div id="ui-container">
    <div class="header-row">
      <h3 id="appTitle">ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ  <span class="badge">v2.11</span></h3>
      <button id="langBtn">ğŸŒ English</button>
    </div>
    
    <div class="tab-container">
      <button id="tab2D" class="tab-btn inactive">ğŸ“Š ì—‘ì…€ í‚¤íŠ¸(2D)</button>
      <button id="tab3D" class="tab-btn active">ğŸ§Š 3D íˆ¬ì‹œë„</button>
    </div>

<div class="link-group" style="margin-bottom:10px;">
        <a href="https://drive.google.com/file/d/112Y3BEiE_loONrF5tPZd6SnDRHyXcrDg/view?usp=sharing" target="_blank" class="link-btn">
            ğŸ“‚ ì—‘ì…€í‚¤íŠ¸ ë‹¤ìš´
        </a>
        <a href="https://docs.google.com/spreadsheets/d/1GW5nJHgax0XTXOPyyVusVr_wKob3S5URJG1lSiAM6bE/edit?usp=sharing" target="_blank" class="link-btn">
            ğŸ“‘ êµ¬ê¸€ì‹œíŠ¸ ì—´ê¸°
        </a>
    </div>
    </div>

    <div id="hintText" class="hint" style="font-size:11px; color:#888;">ë°ì´í„°ë¥¼ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>
    <textarea id="dataInput"></textarea>

    <button id="buildBtn">ğŸ—ï¸ ë„ë©´ ìƒì„±í•˜ê¸° (Build)</button>

    <div id="info">
      <div id="cautionText" class="caution" style="margin-bottom: 8px;">â€» ìƒˆë¡œê³ ì¹¨(F5)í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤!</div>
      <div id="info-2d" style="display:none;">
        <b id="info2dTitle">[2D ëª¨ë“œ ì•ˆë‚´]</b><br/>
        <span id="info2dDrag">âœ… <kbd>í´ë¦­+ë“œë˜ê·¸</kbd>: ë°© ì¡°ê° ì´ë™</span><br/>
        <span id="info2dScroll">âœ… ë§ˆìš°ìŠ¤ íœ : í™”ë©´ ìŠ¤í¬ë¡¤</span><br/>
        <span id="info2dCapture">âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸</span><br/>
      </div>
      <div id="info-3d">
        <b id="info3dTitle">[3D ëª¨ë“œ ì•ˆë‚´]</b><br/>
        <span id="info3dShift">âœ… <kbd>Shift</kbd> + ë“œë˜ê·¸: ë°© ì´ë™</span><br/>
        <span id="info3dMouse">âœ… ì¢Œí´ë¦­: íšŒì „ / ìš°í´ë¦­: ì´ë™</span><br/>
        <span id="info3dLabel">âœ… <kbd>L</kbd>: ê¸€ì”¨(ë¼ë²¨) ë„ê¸°/ì¼œê¸° âœ¨</span><br/>
        <span id="info3dCapture">âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸</span><br/>
        <span id="info3dGhost">âœ… <kbd>G</kbd>: ì •ë‹µ ìœ ë ¹ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°</span>
      </div>
    </div>

    <a href="https://smartstore.naver.com/kiendeod_susutto" target="_blank" id="storeBtn">
      ğŸ›ï¸ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ êµ¬ê²½ê°€ê¸°
    </a>
  </div>

  <div id="viewer-area">
    <div id="twod-container"></div>
    <div id="three-container"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ==========================================
    // 0. ë‹¤êµ­ì–´ ì„¤ì •
    // ==========================================
    const TRANSLATIONS = {
      ko: {
        browserTitle: "ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ ",
        title: "ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ ", 
        langBtn: "ğŸŒ English",
        tab2d: "ğŸ“Š ì—‘ì…€ í‚¤íŠ¸(2D)", tab3d: "ğŸ§Š 3D íˆ¬ì‹œë„",
        hint: "ë°ì´í„°ë¥¼ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.",
        placeholder: "ì˜ˆì‹œ ë°ì´í„°)\n1\tê±°ì‹¤\t5.0\t4.0\t...\n2\tì¹¨ì‹¤\t3.5\t3.0\t...",
        buildBtn: "ğŸ—ï¸ ë„ë©´ ìƒì„±í•˜ê¸° (Build)", caution: "â€» ìƒˆë¡œê³ ì¹¨(F5)í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤!",
        storeBtn: "ğŸ›ï¸ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ êµ¬ê²½ê°€ê¸°",
        info2d: { title: "[2D ëª¨ë“œ ì•ˆë‚´]", drag: "âœ… <kbd>í´ë¦­+ë“œë˜ê·¸</kbd>: ë°© ì¡°ê° ì´ë™", scroll: "âœ… ë§ˆìš°ìŠ¤ íœ : í™”ë©´ ìŠ¤í¬ë¡¤", capture: "âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸" },
        info3d: { title: "[3D ëª¨ë“œ ì•ˆë‚´]", shift: "âœ… <kbd>Shift</kbd> + ë“œë˜ê·¸: ë°© ì´ë™", mouse: "âœ… ì¢Œí´ë¦­: íšŒì „ / ìš°í´ë¦­: ì´ë™", label: "âœ… <kbd>L</kbd>: ê¸€ì”¨(ë¼ë²¨) ë„ê¸°/ì¼œê¸° âœ¨", capture: "âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸", ghost: "âœ… <kbd>G</kbd>: ì •ë‹µ ìœ ë ¹ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°" },
        section1: "1. ë°”ë‹¥ í‰ë©´ë„ (ë“œë˜ê·¸í•´ì„œ ë§ì¶°ë³´ì„¸ìš”!)", section2: "2. ë²½ì²´ ì „ê°œë„ (ê³ ì •ë¨)",
        wallLabels: ["ë²½-A(ì•)", "ë²½-B(ìš°)", "ë²½-C(ë’¤)", "ë²½-D(ì¢Œ)"],
        tooltip: { dim: "ì¹˜ìˆ˜", floor: "ë°”ë‹¥", ceil: "ì²œì¥", peri: "ë‘˜ë ˆ", wall: "ë²½ë©´ì " }
      },
      en: {
        browserTitle: "Ddungdduru's Blueprint Rescue",
        title: "Ddungdduru's Rescue", 
        langBtn: "ğŸŒ í•œêµ­ì–´",
        tab2d: "ğŸ“Š 2D Plan Mode", tab3d: "ğŸ§Š 3D View Mode",
        hint: "Paste your Excel/Sheet data below.",
        placeholder: "Example Data)\n1\tLiving Room\t5.0\t4.0\t...\n2\tBedroom\t3.5\t3.0\t...",
        buildBtn: "ğŸ—ï¸ Generate Blueprint", caution: "â€» Refreshing(F5) will reset everything!",
        storeBtn: "ğŸ›ï¸ Visit Smart Store",
        info2d: { title: "[2D Mode Guide]", drag: "âœ… <kbd>Click+Drag</kbd>: Move Room", scroll: "âœ… Mouse Wheel: Scroll", capture: "âœ… <kbd>P</kbd>: Capture Screen ğŸ“¸" },
        info3d: { title: "[3D Mode Guide]", shift: "âœ… <kbd>Shift</kbd> + Drag: Move Room", mouse: "âœ… L-Click: Rotate / R-Click: Pan", label: "âœ… <kbd>L</kbd>: Toggle Labels âœ¨", capture: "âœ… <kbd>P</kbd>: Capture Screen ğŸ“¸", ghost: "âœ… <kbd>G</kbd>: Toggle Ghost Guide" },
        section1: "1. Floor Plan (Drag to arrange!)", section2: "2. Wall Unfolding (Fixed)",
        wallLabels: ["Wall-A(F)", "Wall-B(R)", "Wall-C(B)", "Wall-D(L)"],
        tooltip: { dim: "Dim", floor: "Floor", ceil: "Ceiling", peri: "Perim", wall: "Wall Area" }
      }
    };
    let currentLang = 'ko';

    // ==========================================
    // 1. ë°ì´í„° ë° ìœ í‹¸ë¦¬í‹°
    // ==========================================
    const EXCEL_COLORS = [
      "#FFCCCC", "#FFE5CC", "#FFFFCC", "#E5FFCC", "#CCFFCC", "#CCFFE5", "#CCFFFF", "#CCE5FF", "#CCCCFF", "#E5CCFF",
      "#FFCCFF", "#FFCCE5", "#FFB2B2", "#FFD6A5", "#FFEF9F", "#CAE799", "#A6E3A1", "#99DDCC", "#9FDBFF", "#ADC1FF",
      "#C8B2FF", "#E0B2FF", "#FFB2F5", "#FFB2D7", "#FFB2B2", "#FF8282", "#FFAA64", "#FFD246", "#B4DC5A", "#78D296"
    ];
    let globalData = [];
    let currentMode = '3d';

    function setLanguage(lang) {
      currentLang = lang;
      const t = TRANSLATIONS[lang];
      document.title = t.browserTitle; 
      document.getElementById('appTitle').innerHTML = `${t.title} <span class="badge">v2.11</span>`;
      document.getElementById('langBtn').innerText = t.langBtn;
      document.getElementById('tab2D').innerText = t.tab2d;
      document.getElementById('tab3D').innerText = t.tab3d;
      document.getElementById('hintText').innerText = t.hint;
      if (!document.getElementById('dataInput').value) document.getElementById('dataInput').placeholder = t.placeholder;
      document.getElementById('buildBtn').innerText = t.buildBtn;
      document.getElementById('cautionText').innerText = t.caution;
      document.getElementById('storeBtn').innerText = t.storeBtn;
      document.getElementById('info2dTitle').innerText = t.info2d.title;
      document.getElementById('info2dDrag').innerHTML = t.info2d.drag;
      document.getElementById('info2dScroll').innerText = t.info2d.scroll;
      document.getElementById('info2dCapture').innerHTML = t.info2d.capture;
      document.getElementById('info3dTitle').innerText = t.info3d.title;
      document.getElementById('info3dShift').innerHTML = t.info3d.shift;
      document.getElementById('info3dMouse').innerText = t.info3d.mouse;
      document.getElementById('info3dLabel').innerHTML = t.info3d.label;
      document.getElementById('info3dCapture').innerHTML = t.info3d.capture;
      document.getElementById('info3dGhost').innerHTML = t.info3d.ghost;
      if(currentMode === '2d' && globalData.length > 0) build2DScene();
    }
    document.getElementById('langBtn').addEventListener('click', () => setLanguage(currentLang === 'ko' ? 'en' : 'ko'));

    function splitCols(line) {
      const t = (line || '').trim();
      if (!t) return null;
      if (t.includes('ê³µê°„ID') || t.includes('ê³µê°„ëª…')) return null;
      if (t.includes('\t')) return t.split('\t').map(s => s.trim());
      if (t.includes(',')) return t.split(',').map(s => s.trim());
      return t.split(/\s+/).map(s => s.trim());
    }
    function parseData() {
      const input = document.getElementById('dataInput').value || '';
      const lines = input.split(/\r?\n/);
      const parsed = [];
      lines.forEach(line => {
        const cols = splitCols(line);
        if (cols && cols.length >= 4 && !isNaN(Number(cols[0])) && cols[1]) {
          const id = parseInt(cols[0], 10);
          const w = parseFloat(cols[2]), d = parseFloat(cols[3]), h = parseFloat(cols[7]) || 2.4;
          if ([w, d].every(Number.isFinite)) {
             const existing = globalData.find(item => item.id === id);
             const x2d = existing ? existing.x2d : null;
             const y2d = existing ? existing.y2d : null;
             parsed.push({ id, name: cols[1], w, d, h, x2d, y2d });
          }
        }
      });
      globalData = parsed;
      return parsed;
    }

    // ==========================================
    // 2. 2D ëª¨ë“œ
    // ==========================================
    const twodContainer = document.getElementById('twod-container');
    const SCALE_2D = 40; 
    let active2DItem = null, active2DOffset = { x: 0, y: 0 };

    function save2DPositions() {
        const rooms = document.querySelectorAll('.room-2d.draggable');
        rooms.forEach(r => {
            const id = parseInt(r.dataset.id);
            const match = globalData.find(d => d.id === id);
            if(match) {
                match.x2d = r.style.left;
                match.y2d = r.style.top;
            }
        });
    }

    twodContainer.addEventListener('pointerdown', e => {
      const target = e.target.closest('.room-2d.draggable');
      if (!target) return;
      active2DItem = target; active2DItem.classList.add('dragging');
      const rect = active2DItem.getBoundingClientRect();
      active2DOffset.x = e.clientX - rect.left; active2DOffset.y = e.clientY - rect.top;
    });
    twodContainer.addEventListener('pointermove', e => {
      if (!active2DItem) return;
      e.preventDefault();
      const containerRect = twodContainer.getBoundingClientRect();
      const currentX = e.clientX - containerRect.left + twodContainer.scrollLeft;
      const currentY = e.clientY - containerRect.top + twodContainer.scrollTop;
      active2DItem.style.left = (currentX - active2DOffset.x) + 'px';
      active2DItem.style.top = (currentY - active2DOffset.y) + 'px';
    });
    twodContainer.addEventListener('pointerup', () => { if(active2DItem) { active2DItem.classList.remove('dragging'); active2DItem = null; }});
    twodContainer.addEventListener('pointerleave', () => { if(active2DItem) { active2DItem.classList.remove('dragging'); active2DItem = null; }});

    function build2DScene() {
      twodContainer.innerHTML = ''; 
      if (!globalData.length) return;
      const t = TRANSLATIONS[currentLang];

      const START_X = 400, START_Y = 70, LIMIT = 1000, GAP = 20;
      let currentX = START_X, currentY = START_Y, maxRowHeight = 0;
      let maxYPoint = 0; 

      const title1 = document.createElement('div');
      title1.className = 'wall-section-title'; title1.innerText = t.section1; title1.style.top = '10px';
      twodContainer.appendChild(title1);

      globalData.forEach(d => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#ddd";
        const wPx = d.w * SCALE_2D, dPx = d.d * SCALE_2D;

        let posX, posY;
        if(d.x2d && d.y2d) {
            posX = d.x2d; posY = d.y2d;
        } else {
            if (currentX + wPx > START_X + LIMIT) { currentX = START_X; currentY += maxRowHeight + GAP; maxRowHeight = 0; }
            posX = currentX + 'px'; posY = currentY + 'px';
            currentX += wPx + GAP; maxRowHeight = Math.max(maxRowHeight, dPx);
        }

        const roomDiv = document.createElement('div');
        roomDiv.className = 'room-2d draggable';
        roomDiv.dataset.id = d.id; 
        roomDiv.style.width = wPx + 'px'; roomDiv.style.height = dPx + 'px';
        roomDiv.style.backgroundColor = color;
        roomDiv.style.left = posX; roomDiv.style.top = posY;
        roomDiv.innerHTML = `<b>${d.name}</b><span>(${d.w} x ${d.d})</span>`;
        twodContainer.appendChild(roomDiv);

        const bottomEdge = parseFloat(posY) + dPx;
        if (bottomEdge > maxYPoint) maxYPoint = bottomEdge;
      });

      let wallStartY = Math.max(maxYPoint + 100, 600);
      
      const title2 = document.createElement('div');
      title2.className = 'wall-section-title unfolding'; title2.innerText = t.section2; title2.style.top = wallStartY + 'px';
      twodContainer.appendChild(title2);
      wallStartY += 60;

      globalData.forEach(d => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#ddd";
        const hPx = d.h * SCALE_2D;
        
        const perim = (d.w + d.d) * 2;
        const wallArea = perim * d.h;

        const roomLabel = document.createElement('div');
        roomLabel.style.position = 'absolute'; 
        roomLabel.style.left = '20px';
        roomLabel.style.top = (wallStartY + hPx/2 - 25) + 'px'; 
        roomLabel.style.lineHeight = '1.4';
        
        roomLabel.innerHTML = `
            <b style="font-size:14px;">[${d.name}]</b> <span style="font-size:11px; color:#666;">(H:${d.h}m)</span><br/>
            <span style="font-size:12px; color:#333;">
                ${t.tooltip.peri}: <b>${perim.toFixed(2)} m</b><br/>
                ${t.tooltip.wall}: <b>${wallArea.toFixed(2)} ã¡</b>
            </span>
        `;
        twodContainer.appendChild(roomLabel);
        
        let currentX = 160;
        const wNames = t.wallLabels;
        [{n:wNames[0],l:d.w}, {n:wNames[1],l:d.d}, {n:wNames[2],l:d.w}, {n:wNames[3],l:d.d}].forEach(w => {
            const wLenPx = w.l * SCALE_2D;
            const wallDiv = document.createElement('div');
            wallDiv.className = 'room-2d';
            wallDiv.style.width = wLenPx + 'px'; wallDiv.style.height = hPx + 'px';
            wallDiv.style.backgroundColor = color;
            wallDiv.style.left = currentX + 'px'; wallDiv.style.top = wallStartY + 'px';
            wallDiv.innerHTML = `<span>${w.n}</span><span style="font-size:10px">(${w.l}x${d.h})</span>`;
            twodContainer.appendChild(wallDiv);
            currentX += wLenPx + 10;
        });
        wallStartY += hPx + 50;
      });
      const finalSpacer = document.createElement('div');
      finalSpacer.style.position = 'absolute'; finalSpacer.style.top = wallStartY + 'px';
      finalSpacer.style.height = '100px'; finalSpacer.style.width = '10px';
      twodContainer.appendChild(finalSpacer);
    }

    // ==========================================
    // 3. 3D íˆ¬ì‹œë„ ëª¨ë“œ
    // ==========================================
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f0f0);
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(12, 12, 16); camera.lookAt(0, 0, 0);
    const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
    renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true;
    document.getElementById('three-container').appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(50, 80, 50); dirLight.castShadow = true; scene.add(dirLight);
    const controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true;
    scene.add(new THREE.GridHelper(100, 100, 0xbbbbbb, 0xeeeeee));

    let pieces = [], ghosts = [], hitMeshes = [], labels3D = [], labelsVisible = true;
    const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    const dragPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
    let dragging = false, draggedGroup = null, dragOffset = new THREE.Vector3();
    let shiftDown = false, ghostsVisible = true;
    const tooltip = document.getElementById('tooltip');
    const canvasElement = renderer.domElement;

    function create3DRoom(d, colorHex) {
      const group = new THREE.Group();
      const w = d.w, depth = d.d, h = d.h;
      const matColor = new THREE.Color(colorHex);
      
      const floor = new THREE.Mesh(new THREE.PlaneGeometry(w, depth), new THREE.MeshStandardMaterial({ color: matColor, side: THREE.DoubleSide }));
      floor.rotation.x = -Math.PI/2; floor.position.y = 0.01; floor.receiveShadow = true; group.add(floor);
      
      const wallMat = new THREE.MeshStandardMaterial({ color: matColor, roughness: 0.7 });
      const w1 = new THREE.Mesh(new THREE.BoxGeometry(w, h, 0.1), wallMat); w1.position.set(0, h/2, -depth/2); group.add(w1);
      const w2 = w1.clone(); w2.position.set(0, h/2, depth/2); group.add(w2);
      const w3 = new THREE.Mesh(new THREE.BoxGeometry(depth, h, 0.1), wallMat); w3.rotation.y = Math.PI/2; w3.position.set(-w/2, h/2, 0); group.add(w3);
      const w4 = w3.clone(); w4.rotation.y = Math.PI/2; w4.position.set(w/2, h/2, 0); group.add(w4);

      const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
      ctx.font = 'bold 40px Malgun Gothic'; const tW = ctx.measureText(d.name).width + 50;
      canvas.width = tW; canvas.height = 110;
      ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle = '#333'; ctx.lineWidth = 5; ctx.strokeRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(d.name, canvas.width/2, 35); ctx.font = '26px Malgun Gothic'; ctx.fillText(`(${d.w}x${d.d})`, canvas.width/2, 80);
      const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
      label.scale.set(tW/20, 5.5, 1); label.position.set(0, h + 2, 0);
      group.add(label); labels3D.push(label); if(!labelsVisible) label.visible = false;

      const hit = new THREE.Mesh(new THREE.PlaneGeometry(w, depth), new THREE.MeshBasicMaterial({visible:false}));
      hit.rotation.x = -Math.PI/2; hit.position.y = 0.1; hit.userData.parentGroup = group;
      group.add(hit); hitMeshes.push(hit);

      const floorArea = w * depth;
      const wallArea = (w + depth) * 2 * h;
      group.userData = { 
          id: d.id, w, d: depth, h, targetPos: new THREE.Vector3(), name: d.name,
          metrics: { floor: floorArea, ceil: floorArea, peri: (w+depth)*2, wall: wallArea }
      };
      return group;
    }

    function build3DScene() {
      pieces.forEach(p => scene.remove(p)); ghosts.forEach(g => scene.remove(g));
      pieces = []; ghosts = []; hitMeshes = []; labels3D = [];
      let x = 0, z = 0, rowH = 0; const LIMIT = 25;
      globalData.forEach(d => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#cccccc";
        const group = create3DRoom(d, color);
        if (x + d.w > LIMIT) { x = 0; z += rowH + 0.5; rowH = 0; }
        group.userData.targetPos.set(x + d.w/2, 0, z + d.d/2);
        x += d.w + 0.5; rowH = Math.max(rowH, d.d);
        const ghost = new THREE.Mesh(new THREE.PlaneGeometry(d.w, d.d), new THREE.MeshBasicMaterial({ color: 0x000000, opacity: 0.15, transparent: true, side: THREE.DoubleSide }));
        ghost.rotation.x = -Math.PI/2; ghost.position.copy(group.userData.targetPos); ghost.position.y = 0.005;
        scene.add(ghost); ghosts.push(ghost);
        group.position.set(group.userData.targetPos.x + (Math.random()-0.5)*15, 0, group.userData.targetPos.z + 8 + Math.random()*8);
        scene.add(group); pieces.push(group);
      });
      ghosts.forEach(g => g.visible = ghostsVisible);
    }

    const tab2D = document.getElementById('tab2D'), tab3D = document.getElementById('tab3D');
    const threeContainerEl = document.getElementById('three-container');

    function switchMode(mode) {
      if(currentMode === '2d') save2DPositions();
      currentMode = mode;
      if (mode === '2d') {
        tab2D.className = 'tab-btn active'; tab3D.className = 'tab-btn inactive';
        twodContainer.style.display = 'block'; threeContainerEl.style.display = 'none';
        document.getElementById('info-2d').style.display = 'block'; document.getElementById('info-3d').style.display = 'none';
        tooltip.style.display = 'none'; 
        build2DScene(); 
      } else {
        tab3D.className = 'tab-btn active'; tab2D.className = 'tab-btn inactive';
        twodContainer.style.display = 'none'; threeContainerEl.style.display = 'block';
        document.getElementById('info-2d').style.display = 'none'; document.getElementById('info-3d').style.display = 'block';
        if (globalData.length > 0 && pieces.length === 0) build3DScene();
        renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
      }
    }
    tab2D.addEventListener('click', () => switchMode('2d')); tab3D.addEventListener('click', () => switchMode('3d'));

    document.getElementById('buildBtn').addEventListener('click', () => {
      parseData();
      if (globalData.length === 0) { alert(currentLang === 'ko'?"ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!":"Check Data!"); return; }
      if (currentMode === '2d') build2DScene(); else build3DScene();
    });

    function getMouse(e) {
        const rect = renderer.domElement.getBoundingClientRect();
        return { x: ((e.clientX - rect.left)/rect.width)*2 - 1, y: -((e.clientY - rect.top)/rect.height)*2 + 1 };
    }
    threeContainerEl.addEventListener('pointerdown', e => {
      if(!shiftDown || currentMode !== '3d') return;
      const m = getMouse(e); raycaster.setFromCamera(m, camera);
      const intersects = raycaster.intersectObjects(hitMeshes);
      if(intersects.length > 0) {
        dragging = true; draggedGroup = intersects[0].object.userData.parentGroup;
        controls.enabled = false; tooltip.style.display = 'none'; 
        canvasElement.style.cursor = 'grabbing'; 
        raycaster.ray.intersectPlane(dragPlane, dragOffset); dragOffset.sub(draggedGroup.position);
      }
    });
    threeContainerEl.addEventListener('pointermove', e => {
      const m = getMouse(e); raycaster.setFromCamera(m, camera);
      
      if(dragging && draggedGroup) {
        const p = new THREE.Vector3(); raycaster.ray.intersectPlane(dragPlane, p);
        draggedGroup.position.copy(p.sub(dragOffset));
        return;
      }

      if(currentMode === '3d') {
          const intersects = raycaster.intersectObjects(hitMeshes);
          
          if(shiftDown && intersects.length > 0) {
             canvasElement.style.cursor = 'grab';
          } else {
             canvasElement.style.cursor = 'auto';
          }

          if(intersects.length > 0 && !dragging) {
              const u = intersects[0].object.userData.parentGroup.userData;
              const t = TRANSLATIONS[currentLang].tooltip;
              tooltip.innerHTML = `
                <b>${u.name}</b>
                <div class="row"><span class="lbl">${t.dim}</span> <span class="val">${u.w} x ${u.d} x ${u.h} m</span></div>
                <div class="row"><span class="lbl">${t.floor}</span> <span class="val">${u.metrics.floor.toFixed(2)} ã¡</span></div>
                <div class="row"><span class="lbl">${t.ceil}</span> <span class="val">${u.metrics.ceil.toFixed(2)} ã¡</span></div>
                <div class="row"><span class="lbl">${t.peri}</span> <span class="val">${u.metrics.peri.toFixed(2)} m</span></div>
                <div class="row"><span class="lbl">${t.wall}</span> <span class="val">${u.metrics.wall.toFixed(2)} ã¡</span></div>
              `;
              tooltip.style.display = 'block';
              tooltip.style.left = (e.clientX + 15) + 'px';
              tooltip.style.top = (e.clientY + 15) + 'px';
          } else {
              tooltip.style.display = 'none';
          }
      }
    });
    threeContainerEl.addEventListener('pointerup', () => {
      if(dragging && draggedGroup) {
        const t = draggedGroup.userData.targetPos;
        if(draggedGroup.position.distanceTo(t) < 0.5) draggedGroup.position.copy(t);
      }
      dragging = false; draggedGroup = null; controls.enabled = true;
      canvasElement.style.cursor = shiftDown ? 'grab' : 'auto';
    });
    threeContainerEl.addEventListener('pointerleave', () => {
        dragging = false; draggedGroup = null; controls.enabled = true;
        canvasElement.style.cursor = 'auto';
    });

    window.addEventListener('keydown', e => {
        const key = e.key.toLowerCase(); if(key==='shift') shiftDown=true;
        
        if(key === 'p') {
           if(currentMode === '2d') {
              html2canvas(document.getElementById('twod-container')).then(canvas => {
                  const link = document.createElement('a');
                  link.download = '2D_Plan.png';
                  link.href = canvas.toDataURL();
                  link.click();
              });
           } else {
              renderScene(); 
              const link=document.createElement('a'); 
              link.download='3D_View.png'; 
              link.href=renderer.domElement.toDataURL('image/png'); 
              link.click(); 
           }
        }
        
        if(currentMode === '3d') {
            if(key==='g') { ghostsVisible=!ghostsVisible; ghosts.forEach(g=>g.visible=ghostsVisible); }
            if(key==='l') { labelsVisible=!labelsVisible; labels3D.forEach(l=>l.visible=labelsVisible); }
        }
    });
    window.addEventListener('keyup', e => { 
        if(e.key==='Shift') {
            shiftDown=false;
            canvasElement.style.cursor = 'auto';
        }
    });
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
      if(currentMode === '2d') build2DScene();
    });

    function renderScene() { renderer.render(scene, camera); }
    function animate() { requestAnimationFrame(animate); if(currentMode === '3d') { controls.update(); renderScene(); } }
    animate();
    
    setLanguage('ko'); switchMode('3d');

  </script>
</body>
</html>
